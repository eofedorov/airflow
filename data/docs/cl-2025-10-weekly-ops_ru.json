{
  "doc_key": "cl-2025-10-weekly-ops",
  "title": "Операционный чеклист CL-2025-10: еженедельные проверки платформы",
  "doc_type": "checklist",
  "created_at": "2025-10-06",
  "content": "# Назначение\nПрофилактический чеклист (45–60 минут) чтобы ловить медленные деградации: диски, очереди, ретеншн, коннекты, секреты. Это не инцидентный процесс.\n\n# 1) Postgres\n- проверить количество коннектов и долгие запросы\n`sql\nselect count(*) from pg_stat_activity;\nselect pid, now()-query_start as age, state, query\nfrom pg_stat_activity\nwhere state <> 'idle'\norder by age desc\nlimit 10;\n`\n- посмотреть bloat на cart_items и stripe_events, планировать maintenance если растет\n\n# 2) PgBouncer\n- убедиться, что сервисы ходят через PgBouncer (application_name и endpoint)\n- смотреть cl_waiting и sv_active\nЕсли видите много прямых подключений к primary, открыть тикет: это предвестник RB-2024-11.\n\n# 3) Redis\n- used_memory и eviction\n- размер payload корзины (cart_cache_value_size_bytes)\nЕсли eviction растет в обычном трафике:\n- подозрение на oversized values\n- отсутствие TTL jitter\n- внезапный рост трафика\n\nПримечание: Redis уже ломал чекаут (PM-2025-11).\n\n# 4) Elasticsearch\n- health green\n- диски ниже watermark\n- алиас products_read существует\n`bash\ncurl -s http://elasticsearch:9200/_cluster/health?pretty\ncurl -s http://elasticsearch:9200/_cat/aliases/products_read?v\ncurl -s http://elasticsearch:9200/_cat/indices/products-v3-*?h=index,store.size,docs.count&s=index\n`\nЕсли индексы старше 14 дней не удаляются, ILM сломан и это вопрос времени до disk watermark.\n\n# 5) Stripe webhooks\n- stripe_webhook_queue_depth на базовом уровне\n- stripe_signature_fail_total близко к 0\nЕсли signature failures > 0:\n- проверять partial rollout секретов\n- проверять ingress путь /webhooks/stripe\n\n# 6) Фоновые джобы\n- Kafka lag индексатора не растет неделями\n- refund-reconciler успешно отработал за 24ч\n- stripe-webhook-replay cronjob не запускается сам по себе\n\n# 7) Секреты и сертификаты\n- Stripe ключи ротируются раз в квартал\n- проверить, что после ротации все поды перезапущены (иначе интермиттентные ошибки)\n- проверить срок TLS сертификатов ingress\n\n# 8) Алерты и дашборды\n- топ шумных алертов, убрать флап\n- убедиться, что панели Grafana не ссылаются на удаленные метрики\n\n# 9) CI/CD и registry\n- нет очередей GitHub Actions\n- последний промоутнутый SHA существует в registry\n- ретеншн registry чистит старые sha теги\n\n# 10) SLO\n- недельный error budget burn для checkout-service и payment-gateway\nЕсли > 30 процентов за неделю, открыть reliability тикет даже без SEV инцидента.\n\n# Выход\nСоздать weekly ops тикет:\n- что проверили\n- что нашли\n- какие тикеты открыли\n\n# Ссылки\n- RB-2024-11, RB-2025-06, RB-2025-12, RB-2026-01, RB-2026-02\n- ADR-2024-08, ADR-2025-02, ADR-2025-03",
  "language": "ru"
}