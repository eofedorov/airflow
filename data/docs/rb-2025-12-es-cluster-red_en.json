{
  "doc_key": "rb-2025-12-es-cluster-red",
  "title": "Runbook: Elasticsearch Cluster Red / Search Degradation",
  "doc_type": "runbook",
  "created_at": "2025-12-03",
  "content": "# Summary\nUse this runbook when product search is degraded due to Elasticsearch cluster health issues (yellow/red), shard allocation failures, threadpool rejections, or indexing backlogs. The primary symptom in production is search-api returning `503 SEARCH_UNAVAILABLE` or timing out while Elasticsearch reports `status: red` and `unassigned_shards > 0`.\n\n**Primary services:** search-api, indexing-worker  \n**Dependency:** Elasticsearch 8.11.3 (K8s, 3 master-eligible + 6 data nodes)  \n**Indexing source:** Postgres `catalog` schema via Kafka topic `catalog.product.changed`\n\n# What “normal” looks like\n- Cluster health: green\n- search-api p95: 120–220ms for `/api/search/products`\n- Threadpool:\n  - `search` queue near 0\n  - `write` queue near 0\n- Indexing lag (Kafka): < 50k messages, catches up within minutes after deploys\n- Storage: data nodes < 70% disk usage (below low watermark)\n\n# Symptoms\n## User-facing\n- Empty results for common queries (“sneakers” returns 0)\n- Filters missing (brand facet empty)\n- Search page loads forever then errors\n\n## Service errors\nsearch-api:\n- `elasticsearch.exceptions.ConnectionTimeout: Connection timed out`\n- `TransportError(429, 'es_rejected_execution_exception', ...)`\n- `index_not_found_exception: no such index [products_read]`\n\nindexing-worker:\n- `BulkIndexError: 200 document(s) failed to index`\n- `mapper_parsing_exception: failed to parse field [attributes.size]`\n\n# Dashboards and alerts\nGrafana:\n- **Search / search-api** (latency, 5xx, 503 rate)\n- **Platform / Elasticsearch / Cluster** (health, disk, JVM, threadpools)\n- **Indexing / Kafka Lag**\n\nPrometheus alerts (typical):\n- `ElasticsearchClusterRed` (cluster status red for 5m)\n- `ElasticsearchDiskHighWatermark` (disk usage > 90%)\n- `SearchApi503Spike` (rate of 503 > threshold)\n\n# Quick triage (first 10 minutes)\n## 1) Check cluster health\n```bash\nkubectl -n ecommerce-prod port-forward svc/elasticsearch 9200:9200\ncurl -s http://localhost:9200/_cluster/health?pretty\n```\nKey fields:\n- `status`: yellow/red is bad\n- `unassigned_shards`\n- `active_primary_shards`\n\n## 2) Check allocation explain\n```bash\ncurl -s -X GET http://localhost:9200/_cluster/allocation/explain?pretty\n```\nLook for causes:\n- `disk_threshold` (most common)\n- `NODE_LEFT` / `node_shutdown`\n- `shards_limit` / `total_shards_per_node`\n\n## 3) Confirm aliases exist\nWe query via alias `products_read` (see ADR-2025-02).\n```bash\ncurl -s http://localhost:9200/_cat/aliases/products_read?v\n```\nIf missing, search-api will fail even if cluster is green.\n\n## 4) Check threadpool rejections\n```bash\ncurl -s http://localhost:9200/_cat/thread_pool/search?v\ncurl -s http://localhost:9200/_cat/thread_pool/write?v\n```\nIf `rejected` increases, reduce load from search-api and/or indexing-worker.\n\n# Mitigation playbook\n## Mitigation A: Disk watermark / unassigned shards\nIf allocation explain shows `disk_threshold`:\n1. Identify old indices and sizes:\n```bash\ncurl -s 'http://localhost:9200/_cat/indices/products-v3-*?h=index,store.size,docs.count&s=index'\n```\n2. Delete indices beyond retention. Default retention is 14 days.\n```bash\ncurl -s -X DELETE 'http://localhost:9200/products-v3-2025.0*'\n```\n3. If deletion is blocked due to ILM, delete manually anyway during incident; fix ILM after.\n\n**Edge case:** If you delete the currently pointed index for `products_read`, search will go hard down. Always check alias target before deleting:\n```bash\ncurl -s 'http://localhost:9200/_cat/aliases/products_read?h=index'\n```\n\n## Mitigation B: Threadpool rejections (429)\nIf ES is overloaded but healthy:\n1. Put search-api into degraded mode:\n- `SEARCH_ENABLE_AGGS=false`\n- `SEARCH_ENABLE_SPELLCHECK=false`\n- `SEARCH_MAX_CONCURRENCY=40` (default 80)\n```bash\nkubectl -n ecommerce-prod set env deploy/search-api SEARCH_ENABLE_AGGS=false SEARCH_ENABLE_SPELLCHECK=false SEARCH_MAX_CONCURRENCY=40\n```\n2. If indexing-worker is also running, reduce pressure by pausing or reducing bulk size (see Mitigation C).\n\n## Mitigation C: Indexing runaway / bulk failures\nIf Kafka lag is huge or bulk indexing is failing:\n1. Pause indexing-worker to let ES recover:\n```bash\nkubectl -n ecommerce-prod scale deploy/indexing-worker --replicas=0\n```\n2. If the issue is mapping/field explosion, pausing buys time but doesn’t fix. Check the failure:\n- `Limit of total fields [1000] has been exceeded`\n- `mapper_parsing_exception` due to inconsistent types (string vs number)\n3. Reduce bulk size on resume:\n- `INDEXING_BULK_SIZE=250` (default 1000)\n- `INDEXING_FLUSH_INTERVAL_MS=750` (default 250)\nThese settings reduce merge pressure.\n\n## Mitigation D: Alias/mapping mismatch after deploy\nIf search-api returns `failed to find field`:\n- It’s usually querying a field removed/renamed in a new index mapping.\nActions:\n1. Roll back search-api to the last compatible version.\n2. If a new index was rolled out, repoint `products_read` alias to previous index as a rollback:\n```bash\ncurl -X POST localhost:9200/_aliases -H 'Content-Type: application/json' -d '{\n  \"actions\": [\n    {\"remove\": {\"alias\": \"products_read\", \"index\": \"products-v3-2025.02.06\"}},\n    {\"add\": {\"alias\": \"products_read\", \"index\": \"products-v3-2025.01.30\"}}\n  ]\n}'\n```\n\n# Recovery\n1. Cluster health green for 10+ minutes.\n2. search-api p95 back < 250ms.\n3. Indexing lag decreasing after workers resume.\n\nWhen resuming indexing-worker:\n- Start with 1 replica, bulk size 250, then scale to normal.\n\n# Edge cases and pitfalls\n- **Hot shards:** a single shard can be overloaded (popular category). Symptoms: normal health but high latency. Use:\n  ```bash\n  curl -s 'http://localhost:9200/_cat/shards/products-v3-*?v&s=store'\n  ```\n- **Master instability:** `master_not_discovered_exception` means cluster coordination problems. Don’t do manual shard allocation until masters stabilize.\n- **Segment merging storms:** if indexing bulk is too aggressive, CPU spikes and searches slow down. Degraded mode helps users while ES catches up.\n- **Type conflicts:** attribute fields (e.g., `attributes.size`) must be normalized in indexing-worker; otherwise mapping rejects.\n\n# References\n- ADR-2025-02 Index aliasing strategy for products\n- API Spec: search-api v3\n- Weekly ops checklist (verify retention and ILM health)",
  "language": "en"
}