{
  "doc_key": "cl-2025-09-prod-deploy",
  "title": "Операционный чеклист CL-2025-09: прод-деплой core сервисов",
  "doc_type": "checklist",
  "created_at": "2025-09-01",
  "content": "# Назначение\nЧеклист для промоута релизов в прод для checkout-service, cart-service, search-api, payment-gateway. Он строгий, потому что большинство аварий было из-за мелочей: env vars, миграции, формат кеша.\n\n# Перед promote\n1) Артефакт\n- определить SHA образа и релиз-ноты\n- убедиться, что staging крутит тот же образ\n- CI прошел на merge commit\n\n2) Просмотреть diff на острые темы\n- миграции alembic\n- Redis ключи/сериализация\n- ES mapping/template\n- Stripe webhook изменения\n- новые env переменные (pydantic Settings)\n\n3) Миграции\n- миграционная джоба должна использовать primary Postgres, не PgBouncer\n- в staging: alembic current == head\n- если миграция тяжелая (индексы на больших таблицах), планировать off-peak или pre-run\n\n4) План отката\nВ issue записать:\n- на какой образ откатываемся\n- кто делает rollback\n- какой сигнал будет триггером отката (например 5xx spike, конверсия, алерты)\n\n# Во время promote\n5) Запуск\n- использовать promote workflow, не kubectl apply руками\n\n6) Мониторить rollout\n`bash\nkubectl -n ecommerce-prod rollout status deploy/<service>\nkubectl -n ecommerce-prod get pods -l app=<service>\n`\nЕсли > 5 минут зависло, см. RB-2025-06.\n\n7) Мониторить дашборды 15 минут\nМинимум:\n- latency и 4xx/5xx\n- Postgres numbackends\n- Redis evicted_keys (если трогали кеш)\n- Stripe webhook queue (если трогали payment-gateway)\n- ES health (если трогали search)\n\n8) Smoke тесты\n- корзина: add/remove + refresh, проверить что не пошли неожиданные 409\n- чекаут: /api/checkout/start с Idempotency-Key, повтор тем же ключом возвращает тот же order_id\n- поиск: базовый запрос, facets (если не degraded)\n- платежи: в staging тестовый платеж и проверить stripe_events\n\n# После деплоя\n9) Error budget\nЕсли burn ускорился, даже при малых абсолютных 5xx, остановиться и расследовать.\n\n10) Логи\nИскать:\n- ValidationError\n- UndefinedColumn\n- redis.exceptions\n- StripeSignatureVerificationError\n- index_not_found_exception\n\n11) Изменения вокруг Redis\nЕсли меняли кеш корзины:\n- наблюдать размеры payload и eviction минимум 30 минут\n- быть готовым включить CART_CACHE_BYPASS (RB-2026-02)\n\n# Экстренный rollback\nОткат если:\n- 5xx скачок сразу после релиза\n- просела конверсия чекаута\n- сломалась проверка подписи вебхуков\n- schema mismatch\n\nКоманды:\n`bash\nkubectl -n ecommerce-prod rollout undo deploy/checkout-service\nkubectl -n ecommerce-prod rollout undo deploy/cart-service\nkubectl -n ecommerce-prod rollout undo deploy/search-api\nkubectl -n ecommerce-prod rollout undo deploy/payment-gateway\n`\n\n# Примечания\n- Не включать LOG_WEBHOOK_PAYLOADS в прод без явного согласования (PM-2025-08)\n- Feature flag подход предпочтителен для рискованных изменений\n- Partial rollout секретов Stripe недопустим: при ротации нужно быстро прокрутить все поды",
  "language": "ru"
}