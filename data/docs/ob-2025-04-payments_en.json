{
  "doc_key": "ob-2025-04-payments",
  "title": "Onboarding: Payments and Stripe Integration",
  "doc_type": "onboarding",
  "created_at": "2025-04-02",
  "content": "# Onboarding: Payments and Stripe Integration (checkout-service + payment-gateway)\n\n## Why this doc exists\nPayments span two services and two “worlds”:\n- user-facing orchestration (checkout-service)\n- Stripe integration + webhook ingestion (payment-gateway)\n\nMost bugs happen at the seams: idempotency, retries, and state transitions. This doc focuses on how things actually work in prod today.\n\n## Components\n- checkout-service (FastAPI): creates orders, requests payment intent creation, reads payment state from Postgres\n- payment-gateway (Node 18): owns Stripe keys, creates PaymentIntents, ingests webhooks\n- Postgres: durable state (`orders`, `payments`, `stripe_events`)\n- Redis: optimization for idempotency (`stripe:evt:*`) and some internal locks\n- Stripe: external payment provider\n\n## High-level flow (happy path)\n1. Client calls checkout-service:\n   - `POST /api/checkout/start` with `Idempotency-Key`\n2. checkout-service validates cart snapshot by calling cart-service with `If-Match` ETag.\n3. checkout-service persists:\n   - `orders` row with status `PAYMENT_PENDING`\n   - `payments` row with `provider='stripe'`, `payment_status='PENDING'`\n4. checkout-service calls payment-gateway internal API:\n   - `POST /internal/stripe/payment_intents`\n5. payment-gateway creates PaymentIntent in Stripe (API version 2023-10-16) and returns `client_secret`.\n6. Client completes card confirmation in the browser.\n7. Stripe sends webhook(s) to payment-gateway.\n8. payment-gateway persists `stripe_events` and processes them.\n9. checkout-service observes updated payment status and transitions order status to `PAID`.\n\n## State machine (simplified)\npayments.payment_status:\n- `PENDING` -> `SUCCEEDED` -> `REFUNDED`\n- failures: `FAILED`, `CANCELED`\n\norders.status:\n- `PAYMENT_PENDING` -> `PAID` -> `FULFILLING` -> `FULFILLED`\n- failures: `PAYMENT_FAILED`, `CANCELLED`\n\nRule: checkout-service is the only service that updates `orders.status`, but it does so based on `payments.payment_status` changes.\n\n## Important invariants\n### Idempotency is mandatory\n- External: checkout-service requires `Idempotency-Key` for `/api/checkout/start`.\n- Internal: payment-gateway maps (order_id, idempotency_key) to a single Stripe PaymentIntent.\n\nIf a client retries due to a network timeout, it must provide the same `Idempotency-Key`, otherwise you can create duplicate PaymentIntents. This is a real support issue.\n\n### Stripe webhooks are authoritative\nWe do not poll Stripe to decide if a payment succeeded (ADR-2024-12). If webhook processing is delayed, order status stays pending. That’s expected; the fix is to restore webhook processing (see Stripe runbook).\n\n### Raw body is required for signature verification\nIf the webhook route parses JSON before verifying signatures, verification fails. This is why we treat `/webhooks/stripe` specially and do not use global `express.json()` there.\n\n## Local dev setup\n### Running payment-gateway locally\n```bash\ncd payment-gateway\nnpm ci\nexport STRIPE_API_KEY=sk_test_...\nexport STRIPE_WEBHOOK_SECRET=whsec_...\nexport DATABASE_URL=postgres://app:app@localhost:5432/ecommerce\nexport REDIS_URL=redis://localhost:6379/0\nnpm run dev\n```\nDefault port: 8090\n\n### Stripe CLI for local webhook forwarding\n```bash\nstripe listen --forward-to localhost:8090/webhooks/stripe\n```\nThe Stripe CLI prints a `whsec_...` secret; set that as `STRIPE_WEBHOOK_SECRET`.\n\nCommon error:\n- `invalid_signature` → you forwarded to the wrong path or your secret is wrong.\n\n## Debugging common scenarios\n### “Stripe shows succeeded but our order is pending”\nCheck `stripe_events` freshness:\n```sql\nselect max(created_at) from stripe_events;\nselect * from payments where order_id = '<id>';\n```\nIf events are arriving but not processed, check `processed_at` and `process_error`.\n\n### “Duplicate fulfillment happened”\nThis usually means:\n- we processed duplicate events incorrectly, or\n- our internal fulfillment consumer is not idempotent.\n\nFirst, verify event idempotency:\n```sql\nselect event_id, count(*) from stripe_events group by 1 having count(*) > 1;\n```\nYou should never see duplicates because event_id is primary key. If you do, schema is broken.\n\n### “Refund requested, never completed”\nRefunds can be partial and multi-step:\n- request creates a refund object\n- Stripe later sends `charge.refunded` or refund updated events\n\nEnsure refund-reconciler job runs daily and can catch up if webhook was missed.\n\n## Edge cases you should know\n- 3DS flows: PaymentIntent can be `requires_action` for minutes; do not treat as failure.\n- Amount rounding: all amounts in Stripe are minor units; ensure `unit_price_minor` is used consistently.\n- Currency: we currently support `USD` and `EUR` only. Stripe may accept others in test mode; prod should reject.\n- Webhook ordering: refund-related events can arrive “before” success events in retries. Processor must be monotonic.\n\n## References\n- ADR-2024-12 Stripe webhooks source of truth\n- Runbook: Stripe webhook backlog\n- API spec: checkout-service v2",
  "language": "en"
}