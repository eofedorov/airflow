{
  "doc_key": "api-2025-11-cart-v1",
  "title": "API Spec: cart-service Public API (v1)",
  "doc_type": "api_spec",
  "created_at": "2025-11-10",
  "content": "# Обзор\ncart-service владеет состоянием корзины. Postgres — источник истины. Redis — кеш производительности (ADR-2025-03). При падении кеша API должно работать (дороже по latency).\n\nBase path: /api/cart\nAuth: Bearer JWT\nИдемпотентность: обязательна на мутациях (Idempotency-Key)\nКонкурентность: optimistic через If-Match (ETag)\n\n# Заголовки\nRequest:\n- Authorization: Bearer <jwt>\n- Idempotency-Key: <uuid> (для POST/DELETE)\n- If-Match: W/<etag> (для мутаций)\n- X-Request-Id (опционально)\n\nResponse:\n- ETag: W/<etag>\n- X-Cache: hit|miss|bypass\n- X-Request-Id\n\n# Модель данных\nCart:\n- cart_id uuid\n- user_id uuid\n- version int\n- currency string (USD или EUR)\n- items array\n- totals subtotal_minor, tax_minor, total_minor\n- updated_at RFC3339\n\nCartItem:\n- sku string\n- qty int 1..99\n- unit_price_minor int\n- title optional\n\n# Формат ошибок\nЕдиный формат:\n`json\n{ 'error_code': 'CODE', 'message': 'text', 'request_id': '...' }\n`\n\nТиповые error_code:\n- CART_NOT_FOUND (404)\n- ITEM_NOT_FOUND (404)\n- INVALID_QTY (422)\n- INVALID_SKU (422)\n- CART_VERSION_MISMATCH (409)\n- PRECONDITION_FAILED (412)\n- IDEMPOTENCY_KEY_REUSE (409)\n- RATE_LIMITED (429)\n\n# Endpoints\n## GET /api/cart/{user_id}\nВозвращает корзину. По умолчанию пустая корзина возвращается как 200 с пустым списком, а не 404.\nQuery:\n- include_empty bool default true\n\nОтвет 200 пример:\n`json\n{\n  'cart_id': '3b3b...',\n  'user_id': '9a9a...',\n  'version': 17,\n  'currency': 'USD',\n  'items': [{'sku': 'SKU-123', 'qty': 2, 'unit_price_minor': 1299}],\n  'totals': {'subtotal_minor': 2598, 'tax_minor': 182, 'total_minor': 2780},\n  'updated_at': '2025-11-02T10:12:30Z'\n}\n`\n\n## POST /api/cart/{user_id}/items\nДобавить или обновить qty.\nHeaders: Idempotency-Key обязателен, If-Match обязателен.\nBody:\n`json\n{ 'sku': 'SKU-123', 'qty': 3 }\n`\nОшибки:\n- 409 CART_VERSION_MISMATCH если ETag устарел\n- 412 PRECONDITION_FAILED если If-Match отсутствует\n- 422 INVALID_QTY/INVALID_SKU\n\nПоведение идемпотентности:\n- Повтор того же ключа с тем же payload должен вернуть тот же результат.\n- Повтор того же ключа с другим payload -> 409 IDEMPOTENCY_KEY_REUSE.\n\n## DELETE /api/cart/{user_id}/items/{sku}\nУдалить позицию.\nHeaders: Idempotency-Key, If-Match обязательны.\nОшибки: 404 ITEM_NOT_FOUND.\n\n## POST /api/cart/{user_id}/clear\nОчистить корзину, version инкрементится.\nИспользуется UI и (опционально) checkout-service после успешного заказа.\n\n## GET /api/cart/{user_id}/items\nПагинация для аномально больших корзин (видели 500+ позиций из-за злоупотреблений API).\nQuery:\n- page_size int default 100 max 200\n- cursor string\nResponse:\n- items\n- next_cursor\n\n# Идемпотентность (внутри)\nПо умолчанию ключи храним в Redis:\n- idem:cart:<user_id>:<key> TTL 24h\nЕсли Redis недоступен, fallback на таблицу Postgres idempotency_keys.\n\n# Нюансы\n- qty=0 не принимаем, удаление только через DELETE. Раньше некоторые клиенты пытались использовать 0, это создавало тихие рассинхроны.\n- Unit price может устареть, финальный пересчет делает checkout-service (иначе PRICE_CHANGED).\n- Redis eviction может повышать mismatch rate, особенно если ETag считался из кешированного payload. Смотри RB-2026-02 и PM-2025-11.\n\n# Changelog\nv1.6 (2025-10) добавили /clear\nv1.7 (2025-11) добавили IDEMPOTENCY_KEY_REUSE",
  "language": "ru"
}