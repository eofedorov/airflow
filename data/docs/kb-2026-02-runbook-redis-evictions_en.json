{
  "doc_key": "kb-2026-02-runbook-redis-evictions",
  "title": "Runbook: Redis Evictions Causing Cart Staleness (cart-service, checkout-service)",
  "doc_type": "runbook",
  "created_at": "2026-02-02",
  "content": "# Summary\nRedis eviction spikes (or Redis being temporarily unavailable) can cause carts to appear stale, totals to mismatch between cart-service and checkout-service, and a surge of 409/412 responses during checkout. This runbook covers detection, mitigation, and recovery.\n\n# Affected components\n- **cart-service** (FastAPI, python 3.11, uvicorn)\n- **checkout-service** (FastAPI)\n- **search-api** (indirect: recommendations in cart)\n- **Redis** (clustered, 3 masters + 3 replicas, Redis 7.2.4)\n- **Postgres** (primary source of truth for cart items)\n\n# Symptoms\n## User-facing\n- Cart shows missing items after refresh\n- Checkout fails with:\n  - `409 CART_VERSION_MISMATCH`\n  - `412 PRECONDITION_FAILED`\n- Totals change between cart page and checkout confirmation\n\n## Service metrics\n- cart-service: increased `redis_cache_miss_total`, `redis_errors_total`\n- checkout-service: increased `cart_fetch_fail_total`, `http_409_total`\n- Redis: `evicted_keys` rising, `used_memory` near `maxmemory`\n\n# Quick triage\n## 1) Confirm incident scope\n- Grafana dashboard: **Platform / Redis / Cache Health**\n  - Look at: `evicted_keys`, `connected_clients`, `keyspace_hits`, `keyspace_misses`\n- Service dashboards:\n  - **cart-service / Latency & Errors**\n  - **checkout-service / Checkout funnel**\n\n## 2) Check recent deploys\n- GitHub Actions: last successful deployment to prod for cart-service/checkout-service.\n- If within the last 30 minutes: suspect a regression in cache keying or TTL.\n\n## 3) Validate Redis connectivity from a pod\n`bash\nkubectl -n ecommerce-prod exec -it deploy/cart-service -- sh\npython -c \"import redis; r=redis.Redis(host='redis.ecommerce-prod.svc', port=6379, socket_connect_timeout=1); print(r.ping())\"\n`\nExpected: `True`. If timeout/connection error: go to **Mitigation A**.\n\n# Mitigation\n## Mitigation A: Redis unavailable or high error rate\n1. Enable **cache bypass** for cart reads in cart-service.\n   - Feature flag: `CART_CACHE_BYPASS=true`\n   - Set via config map `cart-service-config` (requires rollout)\n`bash\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_BYPASS=true\nkubectl -n ecommerce-prod rollout status deploy/cart-service\n`\n2. Confirm cart-service is reading from Postgres only.\n   - Look for log line: `cache=disabled source=postgres`\n3. Watch Postgres load.\n   - If Postgres CPU > 75% or p95 query latency > 200ms, throttle traffic (see **Mitigation D**).\n\n## Mitigation B: Evictions due to maxmemory\n1. Confirm maxmemory policy:\n   - Expected: `allkeys-lfu` (ADR-2025-03-redis-lfu)\n   - If `volatile-ttl` or `noeviction`, notify Infra.\n2. Reduce memory pressure by expiring large keys.\n   - Cart keys pattern: `cart:{user_id}:v{n}`\n`bash\nkubectl -n ecommerce-prod exec -it statefulset/redis-master -- redis-cli --scan --pattern 'cart:*' | head -n 200 | xargs -n 50 redis-cli DEL\n`\n   - Edge case: this will force users to reload carts from Postgres and rehydrate cache. Expect increased DB reads.\n3. Temporarily reduce cache TTL for carts:\n   - Env var: `CART_CACHE_TTL_SECONDS=120` (default 900)\n\n## Mitigation C: Version mismatch storms (409)\n- checkout-service uses optimistic concurrency:\n  - It passes `If-Match: cart_etag` to cart-service.\n- If etags are derived from Redis value and Redis evicts keys, etag may reset.\n1. Enable stable etag derivation from Postgres:\n   - Feature flag: `CART_ETAG_SOURCE=postgres`\n2. Rollout checkout-service.\n\n## Mitigation D: Traffic shaping\nIf DB pressure becomes the primary risk:\n1. Apply rate-limit at ingress for `/api/cart/*` and `/api/checkout/*`.\n2. Prefer 429 over cascading failures.\n\n# Recovery\n## Validate after mitigation\n- cart-service error rate < 1%\n- checkout funnel recovers (conversion within 10% of baseline)\n- Redis `evicted_keys` flat for 10+ minutes\n\n## Re-enable cache (if bypass was set)\n- Only after Redis memory and error rate stabilize.\n`bash\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_BYPASS-\n`\n\n# Edge cases / pitfalls\n- **Ghost carts**: if a user has multiple sessions, stale local storage can re-submit old cart_id; expect `404 CART_NOT_FOUND`.\n- **Large carts** (> 200 items): serialized cart payload can exceed 1MB; Redis ops may exceed `proto-max-bulk-len` if misconfigured. Symptom: `ERR Protocol error: invalid bulk length`.\n- **Clock drift** on app nodes can break TTL-based reconciliation. Check node time sync if only some pods are affected.\n\n# Post-incident actions\n- Create a ticket to verify maxmemory policies and key sizes.\n- Add alert: `increase(redis_evicted_keys_total[5m]) > 0`.\n- Reference related postmortem: **PM-2025-11-redis-oom**.\n",
  "language": "en"
}