{
  "doc_key": "cl-2025-09-prod-deploy",
  "title": "Checklist CL-2025-09: Production Deploy Checklist",
  "doc_type": "checklist",
  "created_at": "2025-09-01",
  "content": "# Checklist CL-2025-09: Production Deploy Checklist (Core Services)\n\n## Purpose\nThis checklist is used when promoting a release to production for any of the core services: checkout-service, cart-service, search-api, payment-gateway. It is intentionally strict because many incidents were caused by “small” changes (env vars, migrations, cache format).\n\nIf you are doing an emergency rollback, skip to the rollback section.\n\n## Before you click “Promote”\n### 1) Confirm the artifact\n- Identify image tag (git sha) and release notes.\n- Ensure staging is running **the same image** you’re about to promote.\n- Verify CI passed on the merge commit (not a rebased SHA).\n\n### 2) Read the diff for “sharp edges”\nSpecifically scan for:\n- DB schema changes (alembic revisions)\n- Redis key formats or serialization changes\n- Elasticsearch mapping/template changes\n- Stripe webhook / payment changes\n- Any new env vars or config keys (pydantic Settings updates)\n\n### 3) Migration readiness\n- Confirm migration job exists and is configured to use Postgres primary, not PgBouncer.\n- In staging, ensure `alembic current == head`.\nIf you see migrations touching:\n- large tables\n- adding indexes\n- column type changes\nthen schedule deploy off-peak or pre-run migration.\n\n### 4) Backout plan\nWrite down (in the deploy issue):\n- “rollback to image X” command\n- who is on point to execute rollback\n- what metric you will watch to decide to rollback\n\n## During the promotion\n### 5) Start deploy\nUse the promote workflow. Do not apply manifests manually unless incident response requires it.\n\n### 6) Watch rollout status\n```bash\nkubectl -n ecommerce-prod rollout status deploy/<service>\nkubectl -n ecommerce-prod get pods -l app=<service>\n```\nIf rollout stalls > 5 minutes, follow RB-2025-06.\n\n### 7) Watch dashboards for 15 minutes\nMinimum dashboards:\n- Service latency + error rate (p50/p95, 4xx/5xx)\n- Postgres connections (`numbackends`)\n- Redis evictions (`redis_evicted_keys_total`) if service touches Redis\n- Stripe webhook queue depth if payment-gateway changed\n- Elasticsearch health if search-api or indexing-worker changed\n\n### 8) Smoke tests (realistic, not “ping”)\nPick 2–3 flows relevant to your change:\n- cart: add item, remove item, refresh, ensure ETag behavior is stable (no unexpected 409)\n- checkout: `/api/checkout/start` with idempotency key; retry request and ensure it returns same order_id\n- search: query common term and verify facets (unless in degraded mode)\n- payments: in staging, run Stripe test payment and confirm webhook processing\n\n## After deploy (stabilization)\n### 9) Confirm error budgets\nIf error budget burn accelerates (even if absolute 5xx seems small), pause and investigate.\n\n### 10) Check logs for new “unknowns”\nSearch for:\n- `ValidationError` (missing env)\n- `UndefinedColumn` (migration drift)\n- `redis.exceptions` spikes\n- `StripeSignatureVerificationError`\n- `index_not_found_exception`\n\n### 11) Redis-sensitive changes\nIf the change impacts cart caching:\n- Watch cache value sizes and evictions for at least 30 minutes.\n- Be ready to enable `CART_CACHE_BYPASS=true` quickly if evictions spike (RB-2026-02).\nRemember: Redis incidents can look like “random cart mismatch” and will be reported by product quickly.\n\n### 12) Document outcomes\nUpdate the deploy issue with:\n- start/end times\n- any anomalies (even if no incident)\n- links to dashboards\n\n## Emergency rollback\nRollback is the default response if:\n- 5xx spikes immediately after deploy\n- checkout conversion drops\n- signature verification fails for Stripe webhooks\n- DB schema mismatch errors appear\n\nCommands:\n```bash\nkubectl -n ecommerce-prod rollout undo deploy/checkout-service\nkubectl -n ecommerce-prod rollout undo deploy/cart-service\nkubectl -n ecommerce-prod rollout undo deploy/search-api\nkubectl -n ecommerce-prod rollout undo deploy/payment-gateway\n```\n\nAfter rollback:\n- capture logs and graphs\n- open a postmortem if user impact > 10 minutes or involves payments\n\n## Notes\n- “Small config changes” are real deploys. Treat them with the same checklist.\n- Do not enable verbose webhook payload logging in prod unless approved; it caused OOMKilled in PM-2025-08.\n\n## Canary and feature flag notes\n- If the change can be feature-flagged, ship code first with flag off, then enable gradually.\n- For risky changes (cache formats, payment state changes), deploy to 10% traffic in staging by scaling and validating mixed-version behavior before production.",
  "language": "en"
}