{
  "doc_key": "kb-2026-01-runbook-stripe-webhook-backlog",
  "title": "Runbook: Stripe Webhook Backlog (payment-gateway, checkout-service)",
  "doc_type": "runbook",
  "created_at": "2026-01-18",
  "content": "# Summary\nStripe webhook delivery delays can cause orders to remain in `PAYMENT_PENDING`, duplicate fulfillment attempts, or missing refunds. This runbook covers diagnosing webhook backlog, verifying signature validation, and replaying events safely.\n\n# Services and dependencies\n- **payment-gateway** (legacy Node.js 18.19, Express)\n- **checkout-service** (FastAPI)\n- **Postgres** (orders, payments tables)\n- **Redis** (idempotency cache)\n- **Stripe** (API version pinned to 2023-10-16 in payment-gateway)\n\n# Symptoms\n## User-facing\n- Order confirmation page shows pending state for > 2 minutes\n- Refund initiated but status stays `REQUESTED`\n\n## Metrics\n- payment-gateway: `stripe_webhook_queue_depth` increasing\n- payment-gateway: `http_5xx_total` spikes on `/webhooks/stripe`\n- checkout-service: `orders_payment_pending_total` elevated\n\n# Immediate checks\n## 1) Stripe dashboard\n- Check recent webhook attempts for endpoint `https://api.company.tld/webhooks/stripe`.\n- Look for status codes:\n  - `400 invalid_signature`\n  - `429 rate_limited`\n  - `500 internal_error`\n\n## 2) payment-gateway logs\nSearch for:\n- `StripeSignatureVerificationError: No signatures found matching the expected signature for payload`\n- `UnhandledPromiseRejection: Error: connect ETIMEDOUT postgres`\n\n## 3) Validate secret and clock drift\nSignature verification is time-sensitive. If nodes drift, Stripe will still send but our code rejects.\n- Confirm env var: `STRIPE_WEBHOOK_SECRET` matches the one in Stripe dashboard.\n- Check time sync on nodes (Kubernetes node status + NTP).\n\n# Mitigation\n## A) If invalid_signature (400)\n1. Confirm the webhook secret in `payment-gateway` deployment.\n`bash\nkubectl -n ecommerce-prod describe deploy/payment-gateway | grep STRIPE_WEBHOOK_SECRET -n\n`\n2. Validate we are not behind a proxy that alters raw body.\n- payment-gateway must use `express.raw({ type: 'application/json' })` on webhook route.\n- If a recent change added `express.json()` globally before the webhook route, rollback.\n\n## B) If rate-limited (429) from our side\n- We throttle webhook handler with `WEBHOOK_MAX_CONCURRENCY`.\n1. Temporarily increase concurrency from 20 to 50.\n`bash\nkubectl -n ecommerce-prod set env deploy/payment-gateway WEBHOOK_MAX_CONCURRENCY=50\nkubectl -n ecommerce-prod rollout status deploy/payment-gateway\n`\n2. Ensure Postgres can handle the write burst.\n\n## C) If Postgres timeouts\n1. Switch payment-gateway to degraded mode: enqueue events only.\n- Env flag: `WEBHOOK_DEFER_DB_WRITES=true`\n- This stores minimal event data in Redis list `stripe:webhook:deferred`.\n2. Once DB is stable, run the replayer job:\n`bash\nkubectl -n ecommerce-prod create job --from=cronjob/stripe-webhook-replay stripe-webhook-replay-manual\n`\n\n# Safe replay / idempotency\nWe rely on idempotency at two layers:\n- Stripe event id: `evt_*` stored in Postgres `payments.stripe_event_id` (unique index)\n- Redis key: `stripe:evt:{id}` TTL 7 days\n\nIf replaying, verify unique constraint exists:\n`sql\n\\d payments;\n-- expect: unique (stripe_event_id)\n`\n\n# Validation steps\n## Confirm backlog draining\n- `stripe_webhook_queue_depth` should trend downward.\n- Stripe dashboard: attempts should return 2xx.\n\n## Confirm state transitions\nRun queries:\n`sql\nselect status, count(*) from orders where created_at > now() - interval '1 hour' group by 1;\nselect payment_status, count(*) from payments where created_at > now() - interval '1 hour' group by 1;\n`\nExpected: `PAYMENT_PENDING` not growing.\n\n# Edge cases\n- **Duplicate charge events**: Stripe can deliver the same event multiple times. Never assume once-only delivery.\n- **Out-of-order events**: `charge.refunded` can arrive before `payment_intent.succeeded` in rare retries. Our handler must tolerate this by checking current DB state.\n- **Large payloads**: Some events include expanded objects. If ingress has a 1MB limit, it may return 413, causing repeated retries.\n- **Partial deploy**: If only some pods have the correct webhook secret, failures appear intermittent.\n\n# Rollback guidance\nIf a deploy introduced signature failures or 500s:\n- Roll back payment-gateway to last known good image tag, typically `payment-gateway:1.38.2`.\n`bash\nkubectl -n ecommerce-prod rollout undo deploy/payment-gateway\n`\n\n# Related docs\n- ADR-2024-12: Stripe webhooks vs polling\n- PM-2025-08: Webhook retries causing duplicate fulfillment\n",
  "language": "en"
}