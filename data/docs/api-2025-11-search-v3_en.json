{
  "doc_key": "api-2025-11-search-v3",
  "title": "API Spec: search-api Public API (v3)",
  "doc_type": "api_spec",
  "created_at": "2025-11-22",
  "content": "# API Spec: search-api Public API (v3)\n\n## Overview\nsearch-api provides product search backed by Elasticsearch. The API is stable even as index mappings evolve via aliases (ADR-2025-02). Search results are not guaranteed to be identical across index versions during reindex windows, but the contract is stable.\n\nBase path: `/api/search`  \nService: `search-api` (FastAPI 0.110)  \nAuth:\n- optional for anonymous search\n- required for personalized boosts (`Authorization: Bearer <jwt>`)\n\n## Request headers\n- `X-Request-Id` (optional)\n- `Accept-Language` (optional; affects analyzer selection for some locales)\n\n## Response headers\n- `X-Request-Id`\n- `X-Search-Degraded: true|false` (when degraded mode enabled)\n\n## Error format\n```json\n{ \"error_code\": \"CODE\", \"message\": \"Text\", \"request_id\": \"...\" }\n```\nError codes:\n- `INVALID_FILTER` (400)\n- `INVALID_SORT` (400)\n- `SEARCH_UNAVAILABLE` (503)\n- `SEARCH_RATE_LIMITED` (429)\n\n## Endpoints\n### GET /api/search/products\nQuery params:\n- `q` (string; empty means “trending”)\n- `page` (int, default 1, min 1)\n- `page_size` (int, default 24, max 100)\n- `filters` (repeatable; format `key:value`)\n  - supported keys: `brand`, `category`, `price_min`, `price_max`, `in_stock`\n- `sort` (`relevance|price_asc|price_desc|newest`)\n- `include_facets` (bool, default true)\n\nResponse 200:\n```json\n{\n  \"total\": 1234,\n  \"page\": 1,\n  \"page_size\": 24,\n  \"results\": [\n    { \"sku\": \"SKU-123\", \"title\": \"Sneaker X\", \"price_minor\": 1299, \"currency\": \"USD\", \"score\": 12.3 }\n  ],\n  \"facets\": {\n    \"brand\": [{\"value\": \"acme\", \"count\": 120}],\n    \"category\": [{\"value\": \"shoes\", \"count\": 900}]\n  }\n}\n```\n\n### GET /api/search/suggest\nAutocomplete suggestions.\n\nQuery params:\n- `q` (string, required)\n- `limit` (int, default 8, max 20)\n\nResponse:\n```json\n{ \"suggestions\": [\"sneakers\", \"sneaker cleaner\", \"sneaker socks\"] }\n```\n\n## Timeouts and retries\nsearch-api sets Elasticsearch client timeouts:\n- connect: 50ms\n- request: 150ms\n\nRetries are disabled to avoid amplifying load during ES overload. If ES returns 429 `es_rejected_execution_exception`, search-api returns:\n- 503 `SEARCH_UNAVAILABLE` with `retry_after_seconds: 2`\n\n## Degraded mode\nWhen ES is overloaded or cluster health is yellow/red:\n- set `SEARCH_ENABLE_AGGS=false` to disable facets\n- set `SEARCH_ENABLE_SPELLCHECK=false`\n- reduce concurrency (`SEARCH_MAX_CONCURRENCY=40`)\n\nIn degraded mode:\n- responses omit `facets`\n- header `X-Search-Degraded: true` is set\n\n## Mapping and alias assumptions\nsearch-api reads from alias:\n- `products_read`\n\nIf alias is missing or points to deleted index:\n- ES returns `index_not_found_exception`\n- search-api returns 503 with `SEARCH_UNAVAILABLE`\n\n## Edge cases\n- Empty query (`q=`): returns trending products cached for 60 seconds. If cache is cold, it runs a lightweight ES query against a curated category list.\n- Filter parsing errors: unknown filter keys return 400 `INVALID_FILTER` with the unknown key in message.\n- Locale analyzers: if `Accept-Language` is unsupported, default analyzer is used; results may be less relevant but should not error.\n- Stale facets during reindex: during dual-write, some categories may have lower counts. This is acceptable; do not treat as bug unless totals are wildly off.\n\n## Observability\nMetrics:\n- `search_requests_total{status}`\n- `search_latency_seconds_bucket`\n- `es_rejections_total`\n- `search_degraded_mode_enabled` (gauge)\n\n## Related docs\n- ADR-2025-02 aliasing and reindex strategy\n- Runbook: ES cluster red / search degradation\n\n## Rate limiting\nAnonymous search is rate limited at the edge:\n- 60 requests / minute / IP for `/products`\n- 120 requests / minute / IP for `/suggest`\n\nWhen limited, response:\n- 429 `SEARCH_RATE_LIMITED`\n- header `Retry-After: 5`\n\nAuthenticated users have higher limits (handled by gateway), but search-api still enforces a soft cap via `SEARCH_MAX_CONCURRENCY` to protect Elasticsearch.\n\n## Internal query behavior (stable contract, variable implementation)\nWe translate request params into an internal query model:\n- match query against `title`, `brand`, `categories`, `keywords`\n- apply filters as bool must clauses\n- ranking:\n  - base BM25 score\n  - boost for `in_stock=true`\n  - optional personalization boost for logged-in users (recently viewed categories)\n\nWe do not expose ES query DSL publicly. However, for debugging in staging you can set header:\n- `X-Debug-Search: true`\nand search-api will include a truncated `debug.query_hash` in the response. It will not include full DSL.\n\n## Additional error scenarios\n- If Elasticsearch is reachable but returns malformed response (rare), search-api returns 502 `SEARCH_UPSTREAM_BAD_RESPONSE`.\n- If the ES client times out (`ConnectionTimeout`), search-api returns 503 with `retry_after_seconds: 1`.\n- If request params exceed limits (e.g., 200 filters), search-api returns 400 `REQUEST_TOO_LARGE`.\n\n## Examples\nBasic query:\n```bash\ncurl 'https://api.company.tld/api/search/products?q=sneakers&page=1&page_size=24&filters=brand:acme&sort=relevance'\n```\n\nSuggest query:\n```bash\ncurl 'https://api.company.tld/api/search/suggest?q=snea&limit=8'\n```\n\n## Changelog\nv3.2 (2025-09): added `newest` sort  \nv3.3 (2025-11): added `X-Search-Degraded` header",
  "language": "en"
}