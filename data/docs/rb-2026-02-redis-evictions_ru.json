{
  "doc_key": "rb-2026-02-redis-evictions",
  "title": "Ранбук: Redis eviction и рассинхрон корзины/чекаута",
  "doc_type": "runbook",
  "created_at": "2026-02-02",
  "content": "# Кратко\nЭтот ранбук для инцидентов, когда Redis (кластер Redis 7.2.4) начинает активно выкидывать ключи, тормозит или становится недоступен, и это приводит к странному поведению корзины и ошибкам при оформлении заказа.\n\nОсновные сервисы: cart-service, checkout-service\n\nКлючевые симптомы: всплеск 409 CART_VERSION_MISMATCH и 412 PRECONDITION_FAILED на POST /api/checkout/start, рост redis_evicted_keys_total, cache miss в cart-service выше 0.85.\n\n# Как выглядит норма\n- cart-service p95 80–140мс\n- checkout-service 409 почти 0\n- Redis: used_memory/maxmemory < 0.75, evicted_keys стабильный 0/мин\n- TTL корзины 900с (CART_CACHE_TTL_SECONDS=900), джиттер включен (CART_CACHE_TTL_JITTER_SECONDS=120)\n\n# Симптомы\n## Пользовательские\n- после обновления страницы корзина как будто теряет часть товаров\n- чекаут зацикливается с сообщением типа корзина изменилась, попробуйте снова\n- платеж висит в pending, но заказ не продвигается\n\n## Логи/ошибки\ncart-service:\n- redis.exceptions.ConnectionError: Error 111 connecting to redis.ecommerce-prod.svc:6379\n- CacheWriteSkipped size_bytes=221332 reason=value_too_large\n- cart_etag_source=redis etag_reset=true\n\ncheckout-service:\n- CartPreconditionFailed: missing If-Match\n- CART_VERSION_MISMATCH expected=18 got=17 cart_id=...\n\n# Где смотреть\nGrafana:\n- Platform / Redis / Cache Health\n- cart-service / Cache + DB\n- checkout-service / Funnel\n\nPrometheus алерты:\n- RedisEvictionsHigh: increase(redis_evicted_keys_total[5m]) > 500\n- CartVersionMismatchSpike: rate(http_responses_total{service=checkout-service,status=409}[5m]) > 5\n\n# Быстрый триаж (до 10 минут)\n1) Проверить масштаб: только корзина/чекаут или еще rate-limit, сессии, идемпотентность Stripe.\n2) Проверить Redis:\n`bash\nkubectl -n ecommerce-prod port-forward svc/redis 6379:6379\nredis-cli -p 6379 INFO memory | egrep 'used_memory_human|maxmemory_human|mem_fragmentation_ratio'\nredis-cli -p 6379 INFO stats | egrep 'evicted_keys|keyspace_hits|keyspace_misses'\nredis-cli -p 6379 CLUSTER INFO\n`\n3) Проверить размер значений корзины:\n- метрика cart_cache_value_size_bytes (p95)\n- если метрики нет, посмотреть логи на CacheWriteSkipped и size_bytes\n4) Проверить деплой за последний час: изменения сериализации корзины, рекомендаций, TTL/джиттера.\n\n# Митигирующие действия\nВыбирайте наименее рискованный вариант.\n\n## Вариант A: Временно обойти Redis для чтения корзины (предпочтительно)\nИдея: cart-service читает из Postgres, не пишет обратно в Redis.\n- CART_CACHE_BYPASS=true\n- CART_CACHE_WRITEBACK=false\n`bash\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_BYPASS=true CART_CACHE_WRITEBACK=false\nkubectl -n ecommerce-prod rollout status deploy/cart-service\n`\nЦена: растет нагрузка на Postgres. Следите за numbackends и p95 checkout.\n\n## Вариант B: Снизить TTL и включить жесткий лимит размера\nЕсли Redis живой, но память упирается в maxmemory:\n- CART_CACHE_TTL_SECONDS=120\n- CART_CACHE_MAX_BYTES=131072\n`bash\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_TTL_SECONDS=120 CART_CACHE_MAX_BYTES=131072\n`\nПримечание: большие корзины могут не кешироваться. Это ок, лучше чем трешинг.\n\n## Вариант C: Стабилизировать ETag\nЕсли основной ущерб от 409:\n- CART_ETAG_SOURCE=postgres (в checkout-service или общий модуль)\n- CHECKOUT_RETRY_ON_CART_MISMATCH=true (временно)\n`bash\nkubectl -n ecommerce-prod set env deploy/checkout-service CART_ETAG_SOURCE=postgres CHECKOUT_RETRY_ON_CART_MISMATCH=true\n`\n\n## Вариант D: Освободить память в Redis (последний шанс)\n1) Найти крупные ключи (осторожно, это может быть медленно):\n`bash\nredis-cli -p 6379 --scan --pattern 'cart:*' | head -n 2000 | xargs -n 50 redis-cli -p 6379 MEMORY USAGE\n`\n2) Удалить только явных монстров (корзины с раздувшимся payload):\n`bash\nredis-cli -p 6379 --scan --pattern 'cart:*' | head -n 500 | xargs -n 50 redis-cli -p 6379 DEL\n`\nРиск: кратковременный скачок нагрузки на Postgres.\n\n# Верификация и откат мер\n- redis_evicted_keys_total перестает расти\n- cache miss падает < 0.5 (после постепенного включения)\n- 409/412 возвращаются к базовому уровню\n\nПостепенно вернуть кеш:\n`bash\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_BYPASS=false CART_CACHE_WRITEBACK=false\n# через 10–15 минут\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_WRITEBACK=true CART_CACHE_TTL_SECONDS=900 CART_CACHE_TTL_JITTER_SECONDS=120\n`\n\n# Острые углы\n- Реплика-лаг: если чтение идет с реплик, ETag может как будто откатываться назад. Проверяйте INFO replication.\n- Смена формата ключей после деплоя: cart: vs cart2: даст 100 процентов miss без eviction.\n- Большие корзины (200+ позиций) могут превышать 256КБ. Должно быть CacheWriteSkipped.\n- Стадо при ре-гидратации: после bypass много корзин одновременно прогреваются. Без джиттера TTL будет синхронный шторм.\n\n# Ссылки\n- ADR-2025-03 Redis как кеш корзины\n- PM-2025-11 Redis eviction сломал чекаут\n- CL-2025-09 чеклист прод-деплоя (наблюдать Redis на изменениях кеша)",
  "language": "ru"
}