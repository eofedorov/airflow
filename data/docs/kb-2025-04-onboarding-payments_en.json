{
  "doc_key": "kb-2025-04-onboarding-payments",
  "title": "Onboarding Guide: Payments Flow (Stripe, payment-gateway, checkout-service)",
  "doc_type": "onboarding",
  "created_at": "2025-04-03",
  "content": "# Overview\nPayments touch multiple services and have strict idempotency and audit requirements. This guide explains the current flow, common pitfalls, and how to test safely.\n\n# Services\n- **checkout-service** (creates orders, initiates payment intents)\n- **payment-gateway** (Node legacy; owns Stripe keys and webhook ingestion)\n- **refund-reconciler** (cronjob; reconciles refunds daily)\n\n# Data model (Postgres)\nKey tables:\n-`orders(id, status, total_amount, currency, created_at)`\n- `payments(id, order_id, provider, payment_status, stripe_payment_intent_id, stripe_event_id)`\n- `stripe_events(event_id, type, payload, processed_at)`\n\nConstraints:\n- `payments.stripe_event_id`has a unique index (prevents double-processing)\n\n# Happy path\n1. Client calls checkout-service:\n-`POST /api/checkout/start`\n2. checkout-service requests payment intent creation from payment-gateway:\n- internal endpoint: `POST /internal/stripe/payment_intents`\n3. payment-gateway creates PaymentIntent in Stripe (API version 2023-10-16).\n4. Client confirms payment via Stripe client SDK.\n5. Stripe sends webhook `payment_intent.succeeded`.\n6. payment-gateway persists event, enqueues processing.\n7. checkout-service updates payment/order state.\n\n# Local testing\n## Stripe CLI\nUse Stripe CLI to forward webhooks to local payment-gateway:\n```bash\nstripe listen --forward-to localhost:8090/webhooks/stripe\n```\nSet env:\n- `STRIPE_WEBHOOK_SECRET`from Stripe CLI output.\n\n## Common local failure\nIf you see`invalid_signature`, ensure the webhook route uses raw body parsing.\n\n# Idempotency rules\n- Stripe events are at-least-once.\n- All handlers must tolerate duplicates and out-of-order delivery.\n\nWe use:\n- Postgres uniqueness on event id\n- Redis TTL key: `stripe:evt:{event_id}`(7 days)\n\n# Operational notes\n- If Postgres is down, payment-gateway should not ack webhooks.\n- If Redis is down, we still rely on Postgres unique constraint (slower but correct).\n\n# Edge cases\n- Partial refunds: multiple`charge.refunded`events can occur.\n- Currency mismatch: Stripe may return amounts in minor units; ensure rounding is consistent.\n- 3DS flows:`requires_action`state can last minutes.\n\n# Where to look when things break\n- Runbook: RB-2026-01 Stripe webhook backlog\n- Postmortem: PM-2025-08 duplicate fulfillment\n- ADR: ADR-2024-12 Stripe webhooks source of truth\n",
  "language": "en"
}