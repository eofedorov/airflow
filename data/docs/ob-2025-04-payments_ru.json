{
  "doc_key": "ob-2025-04-payments",
  "title": "Онбординг: платежи и интеграция со Stripe (checkout-service + payment-gateway)",
  "doc_type": "onboarding",
  "created_at": "2025-04-02",
  "content": "# Зачем этот документ\nПлатежи у нас распределены по двум сервисам:\n- checkout-service (FastAPI) оркестрирует заказ и инициирует платеж\n- payment-gateway (Node 18) владеет Stripe ключами и принимает вебхуки\n\nОсновные баги рождаются на стыках: идемпотентность, ретраи, переходы статусов.\n\n# Компоненты\n- checkout-service: создает orders/payments в Postgres\n- payment-gateway: создает PaymentIntent в Stripe, принимает webhooks\n- Postgres: таблицы orders, payments, stripe_events\n- Redis: ускорение идемпотентности и локи\n\n# Happy path\n1) Клиент вызывает POST /api/checkout/start с Idempotency-Key.\n2) checkout-service валидирует снапшот корзины через cart-service (If-Match).\n3) checkout-service пишет заказ (PAYMENT_PENDING) и платеж (PENDING).\n4) checkout-service вызывает payment-gateway internal API, тот создает PaymentIntent и возвращает client_secret.\n5) Клиент подтверждает карту.\n6) Stripe шлет webhooks.\n7) payment-gateway пишет stripe_events и обрабатывает.\n8) payment_status становится SUCCEEDED, checkout-service переводит order в PAID.\n\n# Инварианты\n## Idempotency обязательна\n- Для /api/checkout/start требуем Idempotency-Key.\n- payment-gateway должен возвращать тот же PaymentIntent при повторе того же ключа.\nЕсли клиент повторит запрос с новым ключом, можно получить дубль PaymentIntent (support боль).\n\n## Webhooks источник истины\nADR-2024-12: не поллим Stripe в горячем пути. Если вебхуки задержались, заказ может зависнуть в pending — это ожидаемо, чинить нужно ingestion.\n\n## Raw body\nПодпись Stripe проверяется по raw body. Если включить JSON parsing до проверки, будет invalid_signature.\n\n# Локальный запуск payment-gateway\n`bash\ncd payment-gateway\nnpm ci\nexport STRIPE_API_KEY=sk_test_...\nexport STRIPE_WEBHOOK_SECRET=whsec_...\nexport DATABASE_URL=postgres://app:app@localhost:5432/ecommerce\nexport REDIS_URL=redis://localhost:6379/0\nnpm run dev\n`\nПорт 8090.\n\n# Stripe CLI для локальных вебхуков\n`bash\nstripe listen --forward-to localhost:8090/webhooks/stripe\n`\nStripe CLI выдаст whsec, его надо положить в STRIPE_WEBHOOK_SECRET.\n\n# Диагностика типовых проблем\n## Stripe показывает succeeded, а у нас pending\n`sql\nselect max(created_at) from stripe_events;\nselect payment_status, provider_payment_id from payments where order_id = '<id>';\n`\nЕсли события приходят, но не обработались, смотрите stripe_events.process_error.\n\n## Дубли отгрузки\nСмотреть PM-2025-08. Даже если Stripe ingest идемпотентен, downstream consumers обязаны быть идемпотентными.\n\n## Refund застрял\nВозвраты асинхронные. Помимо вебхуков есть refund-reconciler (ежедневно). Если вебхук был пропущен, reconciler может догнать.\n\n# Edge cases\n- 3DS: PaymentIntent может быть requires_action долго, это не failure\n- Amount: все суммы в minor units\n- Валюты: поддерживаем USD и EUR. В тесте Stripe пропускает больше, но прод должен отклонять\n- Out-of-order webhooks: возможны при ретраях\n\n# Полезные документы\n- ADR-2024-12\n- RB-2026-01\n- API checkout-service v2\n- PM-2025-08 (идемпотентность внутренних событий)",
  "language": "ru"
}