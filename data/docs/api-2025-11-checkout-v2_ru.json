{
  "doc_key": "api-2025-11-checkout-v2",
  "title": "API Spec: checkout-service Public API (v2)",
  "doc_type": "api_spec",
  "created_at": "2025-11-18",
  "content": "# Обзор\ncheckout-service оркестрирует оформление заказа, создает order/payment в Postgres и инициирует платеж через payment-gateway. Финализация платежа идет по webhooks (ADR-2024-12).\n\nBase path: /api/checkout\nAuth: Bearer JWT\nИдемпотентность: обязательна для /start и refund\n\n# Заголовки\nRequest:\n- Authorization: Bearer <jwt>\n- Idempotency-Key: <uuid> (обязателен для /start)\n- X-Request-Id опционально\n\nResponse:\n- X-Request-Id\n- Retry-After иногда при 503\n\n# Формат ошибок\n`json\n{ 'error_code': 'CODE', 'message': 'text', 'request_id': '...' }\n`\nКоды:\n- CART_VERSION_MISMATCH (409)\n- PRICE_CHANGED (409)\n- ADDRESS_INVALID (422)\n- PAYMENT_PROVIDER_UNAVAILABLE (503)\n- PAYMENT_PENDING_TIMEOUT (409)\n- ORDER_NOT_FOUND (404)\n- ORDER_ALREADY_PAID (409)\n- IDEMPOTENCY_KEY_REUSE (409)\n\n# Статусы\norders.status: PAYMENT_PENDING, PAID, FULFILLING, FULFILLED, PAYMENT_FAILED, CANCELLED\npayments.payment_status: PENDING, SUCCEEDED, FAILED, CANCELED, REFUNDED\n\n# Endpoints\n## POST /api/checkout/start\nСоздает заказ и возвращает client_secret.\nBody:\n`json\n{\n  'user_id': 'uuid',\n  'cart_id': 'uuid',\n  'shipping_address_id': 'uuid',\n  'billing_address_id': 'uuid',\n  'currency': 'USD'\n}\n`\n\nШаги:\n1) Вызывает cart-service GET /api/cart/{user_id} и проверяет If-Match семантику (ETag).\n2) Делает пересчет цен (локально, без внешнего pricing сервиса).\n3) В транзакции пишет orders и payments.\n4) Дергает payment-gateway internal endpoint, создает PaymentIntent.\n\nОтвет 201:\n`json\n{\n  'order_id': 'uuid',\n  'status': 'PAYMENT_PENDING',\n  'payment': {\n    'provider': 'stripe',\n    'payment_intent_id': 'pi_...',\n    'client_secret': 'pi_..._secret_...'\n  }\n}\n`\n\nОшибки:\n- 409 CART_VERSION_MISMATCH если корзина изменилась\n- 409 PRICE_CHANGED если пересчет дал другие totals\n- 503 PAYMENT_PROVIDER_UNAVAILABLE если payment-gateway недоступен\n\nНюанс: если payment-gateway таймаутит, но успел создать PaymentIntent, повтор с тем же Idempotency-Key должен вернуть тот же intent. Если это ломается, будет дубль intent.\n\n## GET /api/checkout/orders/{order_id}\nПолные детали заказа и платежа.\n\n## GET /api/checkout/orders/{order_id}/status\nЛегкий endpoint для UI polling:\n`json\n{ 'order_id': '...', 'status': 'PAYMENT_PENDING', 'payment_status': 'PENDING' }\n`\nКешируется на edge 2 секунды, не использовать как источник корректности.\n\n## POST /api/checkout/orders/{order_id}/cancel\nОтмена неоплаченного заказа.\nПравила:\n- если payment_status=SUCCEEDED -> 409 ORDER_ALREADY_PAID\n- если pending старше 10 минут, отмена разрешена\n\n## POST /api/checkout/orders/{order_id}/refund\nАсинхронный возврат (обычно support tooling). Требует elevated scope.\nHeaders: Idempotency-Key обязателен.\nBody:\n`json\n{ 'amount_minor': 2780, 'reason': 'customer_request' }\n`\nОтвет: 202 accepted.\n\n# Идемпотентность\n- Для /start ключ хранится в таблице checkout_idempotency с unique (user_id, key).\n- Повтор с другим cart_id/address_id -> IDEMPOTENCY_KEY_REUSE.\n\n# Observability\nМетрики:\n- checkout_start_total\n- checkout_cart_mismatch_total\n- payment_provider_errors_total\n- orders_payment_pending_total\n\nЛоги:\n- order_id, user_id, cart_id, provider_payment_id, request_id\n\n# Edge cases\n- Pending слишком долго: UI может предложить поддержку, backend может вернуть PAYMENT_PENDING_TIMEOUT\n- Out-of-order Stripe события: успех может прийти после cancel. Тогда политика: предпочитать SUCCEEDED и затем инициировать refund, если нужно.\n- Currency mismatch: если валюта корзины не совпала с запросом, возвращаем 422 CURRENCY_MISMATCH\n- 304 от cart-service: checkout-service не должен доверять только UI totals, должен сверить со снапшотом\n\n# Связанные документы\n- ADR-2024-12\n- RB-2026-01\n- OB-2025-04",
  "language": "ru"
}