{
  "doc_key": "kb-2025-11-api-cart-service",
  "title": "API Spec: cart-service Public API (v1)",
  "doc_type": "api_spec",
  "created_at": "2025-11-02",
  "content": "# Overview\ncart-service owns cart state and exposes endpoints for reading and mutating carts. Postgres is the source of truth; Redis is a performance cache (see ADR-2025-03).\n\nBase URL: `/api/cart`\nAuth: bearer token, required for all endpoints.\nIdempotency: mutation endpoints accept `Idempotency-Key`header.\n\n# Models\n## Cart\n-`cart_id`(uuid)\n-`user_id`(uuid)\n-`version`(int)\n-`items`(list)\n-`currency`(string)\n-`updated_at`(RFC3339)\n\n## CartItem\n-`sku`(string)\n-`qty`(int, 1..99)\n-`unit_price_minor`(int)\n\n# Endpoints\n## GET /api/cart/{user_id}\nReturns the current cart.\n\nHeaders:\n- Optional:`If-None-Match`(ETag)\n\nResponses:\n- 200: cart payload\n- 304: not modified\n- 404:`{ 'error_code': 'CART_NOT_FOUND' }`\n\nExample response:\n```json\n{\n  \"cart_id\": \"3b3b6f9e-0f2e-4f0c-9d8a-1b2a3c4d5e6f\",\n  \"user_id\": \"9a9a...\",\n  \"version\": 17,\n  \"currency\": \"USD\",\n  \"items\": [{\"sku\": \"SKU-123\", \"qty\": 2, \"unit_price_minor\": 1299}],\n  \"updated_at\": \"2025-11-02T10:12:30Z\"\n}\n```\n\n## POST /api/cart/{user_id}/items\nAdds or updates an item.\n\nHeaders:\n- `Idempotency-Key: <uuid>`\n- `If-Match: <etag>`(required)\n\nRequest:\n```json\n{ \"sku\": \"SKU-123\", \"qty\": 3 }\n```\n\nResponses:\n- 200: updated cart\n- 409:`{ 'error_code': 'CART_VERSION_MISMATCH' }`\n- 412: `{ 'error_code': 'PRECONDITION_FAILED' }`(missing/invalid If-Match)\n- 422:`{ 'error_code': 'INVALID_QTY' }`\n\nEdge cases:\n- qty 0 is rejected (use DELETE endpoint).\n- large carts (>200 items) may exceed payload size limits; clients should paginate using `GET /api/cart/{user_id}/items?cursor=...`(internal-only).\n\n## DELETE /api/cart/{user_id}/items/{sku}\nRemoves an item.\n\nResponses:\n- 200: updated cart\n- 404:`{ 'error_code': 'ITEM_NOT_FOUND' }`\n\n# Caching headers\n- cart-service returns:\n  - `ETag: W/<hash>`\n  - `Cache-Control: private, max-age=0`\n\n# Error format\nAll errors:\n```json\n{ \"error_code\": \"...\", \"message\": \"...\", \"request_id\": \"...\" }\n```\n\n# Operational notes\n- If Redis is unavailable, `X-Cache: bypass`is set.\n- If Redis evictions spike, users may see more 409s (see RB-2026-02).\n",
  "language": "en"
}