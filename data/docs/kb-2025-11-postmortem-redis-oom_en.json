{
  "doc_key": "kb-2025-11-postmortem-redis-oom",
  "title": "Postmortem: Redis OOM and Evictions Broke Checkout Consistency",
  "doc_type": "postmortem",
  "created_at": "2025-11-30",
  "content": "# Incident summary\nOn 2025-11-29, Redis experienced sustained memory pressure leading to OOM behavior and heavy evictions. cart-service cache churn caused a surge in cart version mismatches during checkout, reducing conversion.\n\n# Impact\n- Duration: 47 minutes (09:12â€“09:59 UTC)\n- 12.4% of checkout attempts failed with 409/412\n- Cart page latency increased from p95 120ms to 410ms\n\n# Timeline\n- 09:12: Alerts: `redis_evicted_keys`rising\n- 09:16: checkout-service error rate spikes (409)\n- 09:22: Oncall enables CART_CACHE_BYPASS\n- 09:31: Redis memory stabilizes after key cleanup\n- 09:45: Gradual re-enable cache\n- 09:59: Metrics return to baseline\n\n# Root cause\nA new feature in cart-service stored expanded recommendation payloads inside cart cache values (including 20 recommended SKUs with metadata). Average cart cache value size increased ~6x, exceeding the expected memory budget.\n\nRedis config at the time:\n-`maxmemory 18gb`\n- `maxmemory-policy allkeys-lfu`\n\nLFU helped, but the increase in value size caused:\n- rapid evictions under load\n- increased misses -> more Postgres reads\n- ETag derived inconsistently when cache keys were evicted and rehydrated concurrently\n\n# Contributing factors\n- Missing alert on average Redis value size for `cart:*`keys\n- Load test did not include Black Friday recommendation payload shape\n- checkout-service treated 409 as a hard failure rather than retrying with refreshed ETag\n\n# Detection\nPrometheus alerts fired:\n-`increase(redis_evicted_keys_total[5m]) > 0`\n- `http_409_total`for checkout-service\n\n# Resolution\n- Enabled`CART_CACHE_BYPASS=true`to stop dependency on Redis\n- Purged oversized cart keys\n- Deployed hotfix to store only recommendation SKUs, not full metadata\n\n# What went well\n- Oncall had a documented bypass flag\n- Rollout of env changes was quick\n\n# What went poorly\n- Redis issue cascaded into checkout failures\n- Purging keys caused temporary DB pressure\n\n# Action items\n1. Enforce max cart cache value size (hard cap 128KB); if exceeded, skip caching.\n2. Update checkout-service to retry once on`CART_VERSION_MISMATCH`by refetching cart.\n3. Add dashboards:\n- average value size by key prefix\n4. Revisit ADR-2025-03 assumptions: Redis as primary cache for carts increases coupling.\n\n# Related\n- Runbook: RB-2026-02 Redis evictions\n- ADR: ADR-2025-03 Redis cart cache\n",
  "language": "en"
}