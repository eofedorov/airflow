{
  "doc_key": "api-2025-11-cart-v1",
  "title": "API Spec: cart-service Public API (v1)",
  "doc_type": "api_spec",
  "created_at": "2025-11-10",
  "content": "# API Spec: cart-service Public API (v1)\n\n## Overview\ncart-service owns cart state and exposes endpoints to read and mutate a user’s cart. Postgres is the system of record. Redis is a performance cache (ADR-2025-03) and must not affect correctness: if cache is down, endpoints should still work (with higher latency).\n\nBase path: `/api/cart`  \nService: `cart-service` (FastAPI 0.110)  \nAuth: Bearer token required for all public endpoints  \nIdempotency: Required for mutation endpoints via `Idempotency-Key`\n\n## Headers\n### Request\n- `Authorization: Bearer <jwt>`\n- `Idempotency-Key: <uuid>` (mutations)\n- `If-Match: W/<etag>` (mutations; optimistic concurrency)\n- `X-Request-Id: <string>` (optional; if absent, generated)\n\n### Response\n- `ETag: W/<etag>` (GET and successful mutations)\n- `X-Cache: hit|miss|bypass` (informational)\n- `X-Request-Id: <string>`\n\n## Data model\n### Cart\n- `cart_id` (uuid)\n- `user_id` (uuid)\n- `version` (int, increments on each mutation)\n- `currency` (string; currently `USD` or `EUR`)\n- `items` (array of CartItem)\n- `totals` (object; includes `subtotal_minor`, `tax_minor`, `total_minor`)\n- `updated_at` (RFC3339)\n\n### CartItem\n- `sku` (string, required)\n- `qty` (int 1..99)\n- `unit_price_minor` (int, >= 0)\n- `title` (string, optional; may be omitted in some responses)\n\nNote: price is captured at time of cart update; final checkout may reprice (checkout-service responsibility).\n\n## Error format\nAll errors use:\n```json\n{ \"error_code\": \"SOME_CODE\", \"message\": \"Human readable\", \"request_id\": \"...\" }\n```\n\nCommon error codes:\n- `CART_NOT_FOUND` (404)\n- `ITEM_NOT_FOUND` (404)\n- `INVALID_QTY` (422)\n- `INVALID_SKU` (422)\n- `CART_VERSION_MISMATCH` (409)\n- `PRECONDITION_FAILED` (412; missing or invalid If-Match)\n- `RATE_LIMITED` (429)\n- `UPSTREAM_PRICING_UNAVAILABLE` (503; if pricing dependency is enabled)\n\n## Endpoints\n### GET /api/cart/{user_id}\nReturns the current cart. If none exists, returns an empty cart object (not 404) unless `include_empty=false`.\n\nQuery params:\n- `include_empty` (bool, default true)\n\nResponses:\n- 200: Cart payload\n- 304: Not modified (when `If-None-Match` used)\n\nExample request:\n```bash\ncurl -H \"Authorization: Bearer $TOKEN\" \\\n     -H \"If-None-Match: W/\\\\\\\"c17:abc\\\\\\\"\" \\\n     https://api.company.tld/api/cart/9a9a...\n```\n\nExample response 200:\n```json\n{\n  \"cart_id\": \"3b3b6f9e-0f2e-4f0c-9d8a-1b2a3c4d5e6f\",\n  \"user_id\": \"9a9a...\",\n  \"version\": 17,\n  \"currency\": \"USD\",\n  \"items\": [{\"sku\": \"SKU-123\", \"qty\": 2, \"unit_price_minor\": 1299}],\n  \"totals\": {\"subtotal_minor\": 2598, \"tax_minor\": 182, \"total_minor\": 2780},\n  \"updated_at\": \"2025-11-02T10:12:30Z\"\n}\n```\n\n### POST /api/cart/{user_id}/items\nAdds or updates an item quantity.\n\nHeaders:\n- `Idempotency-Key` required\n- `If-Match` required (use latest ETag from GET)\n\nRequest body:\n```json\n{ \"sku\": \"SKU-123\", \"qty\": 3 }\n```\n\nResponses:\n- 200: updated cart\n- 409: `CART_VERSION_MISMATCH` (ETag does not match current cart version)\n- 412: `PRECONDITION_FAILED` (missing If-Match)\n- 422: `INVALID_QTY` or `INVALID_SKU`\n\nExample mismatch response:\n```json\n{ \"error_code\": \"CART_VERSION_MISMATCH\", \"message\": \"Cart changed, refetch required\", \"request_id\": \"...\" }\n```\n\n### DELETE /api/cart/{user_id}/items/{sku}\nRemoves an item.\n\nHeaders:\n- `Idempotency-Key` required\n- `If-Match` required\n\nResponses:\n- 200: updated cart\n- 404: `ITEM_NOT_FOUND`\n\n### POST /api/cart/{user_id}/clear\nClears the cart entirely (sets items to empty, increments version).\n\nThis is used by UI “clear cart” and by checkout-service after successful order placement (optional; feature-flagged).\n\n### GET /api/cart/{user_id}/items\nReturns items in a paginated way for extremely large carts (rare, but support has seen > 500 items due to API abuse).\n\nQuery params:\n- `page_size` (int, default 100, max 200)\n- `cursor` (opaque string)\n\nResponse includes:\n- `next_cursor` (null if end)\n\n## Idempotency behavior\ncart-service stores idempotency keys in Redis:\n- `idem:cart:{user_id}:{key}` TTL 24 hours\nIf Redis is down, we fall back to Postgres table `idempotency_keys` (slower).\n\nIf the same idempotency key is replayed with a different payload, return:\n- 409 `IDEMPOTENCY_KEY_REUSE`\n\n## Edge cases and notes\n- **Race with checkout:** checkout-service may read cart and then mutate it (e.g., applying coupon) while the user also changes qty. Clients must handle 409 and refetch.\n- **Qty 0:** rejected; use DELETE to remove items. (We treat qty=0 as ambiguous because some clients tried to use it as a remove operation, creating silent mismatches.)\n- **SKU reprice:** if pricing changes, cart-service does not automatically update unit_price_minor; checkout-service performs final pricing validation and may reject checkout with `PRICE_CHANGED`.\n- **Redis evictions:** can increase mismatch rate if ETag derivation relies on cached payload. See RB-2026-02 and PM-2025-11.\n\n## Changelog notes\nv1.6 (2025-10): added `/clear` endpoint  \nv1.7 (2025-11): added `IDEMPOTENCY_KEY_REUSE` error",
  "language": "en"
}