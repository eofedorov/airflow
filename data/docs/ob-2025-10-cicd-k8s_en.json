{
  "doc_key": "ob-2025-10-cicd-k8s",
  "title": "Onboarding: CI/CD and Kubernetes Conventions",
  "doc_type": "onboarding",
  "created_at": "2025-10-12",
  "content": "# Onboarding: CI/CD and Kubernetes in This Platform (GitHub Actions + Docker + K8s)\n\n## Overview\nThis doc explains how code moves from a PR to production and how to debug common CI and deploy issues. It’s not a Kubernetes tutorial; it’s the conventions and sharp edges specific to our stack.\n\n## Environments and namespaces\n- Staging: `ecommerce-staging`\n- Production: `ecommerce-prod`\n\nIngress hostnames:\n- staging: `staging-api.company.tld`\n- prod: `api.company.tld`\n\n## Container images\nWe build and push images per service.\nNaming convention:\n- `<service>:<git-sha>` (immutable build artifact)\n- `<service>:v<semver>` (release tag, points to a sha)\n\nExample:\n- `checkout-service:9f2c1a3`\n- `checkout-service:v2.14.0`\n\nDo not deploy “latest”.\n\n## GitHub Actions workflows\nEach service has:\n- `.github/workflows/ci.yml` (runs on PR)\n- `.github/workflows/release.yml` (tags + builds release image)\nPlatform has:\n- `.github/workflows/promote.yml` (promotes to prod)\n\nTypical CI jobs:\n1. `lint`:\n   - ruff 0.4.x\n   - mypy (select services)\n2. `test`:\n   - pytest (unit + integration depending on service)\n3. `build`:\n   - docker buildx\n4. `push`:\n   - push to registry\n\nSnippet (simplified):\n```yaml\n- name: Build\n  run: docker buildx build -t registry/company/checkout-service:${{ github.sha }} .\n- name: Push\n  run: docker push registry/company/checkout-service:${{ github.sha }}\n```\n\nCommon CI failure:\n- “tests pass locally but fail in CI” → missing service dependency (Redis/ES) or different env var defaults.\n\n## Deploy process (happy path)\n1. Merge to `main` triggers auto-deploy to staging.\n2. Validate staging (smoke tests).\n3. Trigger `promote.yml` with the image SHA to deploy to production.\n4. Watch rollout status and dashboards for 15 minutes.\n\n## Kubernetes resources and conventions\n- Deployments: web services (checkout-service, cart-service, search-api, payment-gateway)\n- CronJobs: migrations, refund-reconciler, Stripe replay\n- ConfigMaps: non-secret config (timeouts, feature flags)\n- Secrets: Stripe keys, DB passwords\n\nPorts:\n- containerPort 8080 (FastAPI)\n- containerPort 8090 (payment-gateway)\n\nHealth probes:\n- liveness: `/health/live`\n- readiness: `/health/ready`\n\n**Important:** liveness must not depend on Postgres/Redis/ES. If it does, transient dependency failures turn into restart storms.\n\n## Debugging deploy failures\n### Rollout stuck\nUse the runbook RB-2025-06. Fast path:\n```bash\nkubectl -n ecommerce-prod rollout status deploy/cart-service\nkubectl -n ecommerce-prod get pods -l app=cart-service\nkubectl -n ecommerce-prod describe pod <pod>\nkubectl -n ecommerce-prod logs <pod> --previous\n```\n\n### Config mistakes\nFastAPI services validate env vars at startup (pydantic). Missing secrets fail fast with a `ValidationError`. If you see this in prod, rollback is usually faster than patching unless you know the exact missing key.\n\n### Migrations and schema drift\nIf a deploy adds a DB column, you must ensure migrations run (PM-2025-07 describes what happens otherwise). Our promote workflow is supposed to run migration jobs, but verify it.\n\n## Observability basics\n- Services export Prometheus metrics at `/metrics`.\n- Grafana dashboards are organized by service and platform components.\n- Always include `X-Request-Id` when debugging cross-service calls.\n\n## Edge cases\n- Partial rollouts can create mixed versions and inconsistent cache formats (Redis key changes). Prefer rollback.\n- If your deploy changes Redis usage, watch `redis_evicted_keys_total` and cart mismatch errors for at least 30 minutes.\n- If your deploy changes search mappings, validate `products_read` alias and retention settings.\n\n## Related docs\n- Checklist: Production deploy\n- Runbooks: Rollout stuck, Postgres connection exhaustion, Redis evictions\n\n## Local Kubernetes (optional but useful)\nWe use kind for local k8s smoke tests (mostly for ingress/probes).\n```bash\nkind create cluster --name ecommerce-dev\nkubectl create ns ecommerce-dev\nkubectl -n ecommerce-dev apply -f infra/k8s/dev/\n```\nIf pods fail due to image pull, load images into kind:\n```bash\nkind load docker-image checkout-service:local --name ecommerce-dev\n```\n\n## Rollback guidance\nRollback is normal. If a production deploy triggers a sudden error spike, roll back first, debug second.\n```bash\nkubectl -n ecommerce-prod rollout undo deploy/checkout-service\nkubectl -n ecommerce-prod rollout undo deploy/cart-service\n```\nAfter rollback, capture logs and metrics for the postmortem.\n\n## Secret rotation note\nStripe secrets are rotated quarterly. If you change `STRIPE_WEBHOOK_SECRET`, you must roll all payment-gateway pods quickly; partial rollout causes intermittent signature failures.",
  "language": "en"
}