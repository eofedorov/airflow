{
  "doc_key": "adr-2024-08-pgbouncer",
  "title": "ADR-2024-08: PgBouncer в режиме transaction pooling для Postgres",
  "doc_type": "adr",
  "created_at": "2024-08-22",
  "content": "# Статус\nПринято (2024-08-22)\n\n# Контекст\nСуммарное число подключений к Postgres стало неконтролируемым: web pods * workers * pool size + фоновые воркеры. На пиках это приводило к:\n- FATAL too many clients\n- каскадным таймаутам\n- деградации p95 из-за churn\n\nУвеличивать max_connections — не решение: растет память на backend и падает производительность.\n\n# Решение\nВводим PgBouncer в режиме transaction pooling для всего app трафика.\n- Приложения по умолчанию подключаются к PgBouncer (порт 6432)\n- Прямые подключения к primary Postgres (5432) только для миграций и админских задач\n\n# Дизайн\n## Базовые настройки PgBouncer (prod)\n`ini\npool_mode = transaction\nmax_client_conn = 5000\ndefault_pool_size = 50\nreserve_pool_size = 10\nserver_idle_timeout = 60\nquery_wait_timeout = 120\nignore_startup_parameters = extra_float_digits\n`\n\n## Конфиг сервисов\nFastAPI (SQLAlchemy 2.0 + psycopg):\n- DATABASE_URL на PgBouncer\n- маленький client pool чтобы не делать pool-on-pool:\n  - DB_POOL_SIZE=10\n  - DB_MAX_OVERFLOW=5\n\nNode payment-gateway (pg):\n- max=20\n- таймауты задавать на транзакцию, не через session state\n\n## Ограничения совместимости\nTransaction pooling ломает:\n- session-scoped prepared statements\n- temp tables между запросами\n- SET ROLE/SET search_path без повторного применения\n\nПолитика: если сервис требует session semantics, он должен обосновать исключение.\n\n## Мониторинг\n- PgBouncer cl_waiting, sv_active\n- Postgres numbackends\n- ошибки timeout waiting for server connection\n\n# Последствия\nПлюсы:\n- резкое снижение numbackends\n- стабильность p95\n\nМинусы:\n- PgBouncer становится критическим компонентом\n- возможны неожиданные баги библиотек\n- миграции должны идти мимо PgBouncer\n\n# План внедрения\n- staging на одном сервисе\n- миграция по одному сервису\n- в чеклист деплоя добавить проверку DATABASE_URL\n\n# Edge cases\n- PgBouncer saturation: latency растет даже при здоровом Postgres\n- деплой, случайно указывающий на primary, быстро выжигает max_connections\n- миграции через PgBouncer могут вести себя странно (это случилось в PM-2025-07)\n\n# Связанные документы\n- RB-2024-11 исчерпание подключений\n- PM-2025-07 миграции и schema drift\n- CL-2025-09 прод-деплой",
  "language": "ru"
}