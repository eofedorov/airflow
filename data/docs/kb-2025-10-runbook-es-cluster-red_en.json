{
  "doc_key": "kb-2025-10-runbook-es-cluster-red",
  "title": "Runbook: Elasticsearch Cluster Red / Search Degradation (search-api, indexing-worker)",
  "doc_type": "runbook",
  "created_at": "2025-10-07",
  "content": "# Summary\nThis runbook addresses Elasticsearch cluster health issues (yellow/red) leading to degraded search results, timeouts in search-api, and indexing lag. It assumes Elasticsearch 8.11.x deployed on Kubernetes with 3 master-eligible nodes and 6 data nodes.\n\n# Affected components\n- **search-api** (FastAPI)\n- **indexing-worker** (Python Celery worker consuming Kafka topic `catalog.product.changed`)\n- **Elasticsearch** (8.11.3)\n- **Postgres** (source of truth for product catalog)\n\n# Symptoms\n- search-api returns `503 SEARCH_UNAVAILABLE` or `504 upstream timeout`\n- p95 latency > 800ms on `/api/search`\n- Indexing lag: Kafka consumer group `indexing-worker` lag increases\n- Elastic health is `red` or `yellow`\n\n# Initial triage\n## 1) Check cluster health\n`bash\nkubectl -n ecommerce-prod port-forward svc/elasticsearch 9200:9200\ncurl -s http://localhost:9200/_cluster/health?pretty\n`\nKey fields:\n- `status`: green/yellow/red\n- `unassigned_shards`\n\n## 2) Check shard allocation explain\n`bash\ncurl -s -X GET http://localhost:9200/_cluster/allocation/explain?pretty\n`\nLook for:\n- `NODE_LEFT`\n- `disk_threshold`\n- `shards_limit`\n\n## 3) search-api errors\nCommon error snippet:\n- `elasticsearch.exceptions.ConnectionTimeout: Connection timed out`\n- `TransportError(429, 'es_rejected_execution_exception', ...)`\n\n# Mitigation paths\n## A) Disk watermarks (most common)\nIf allocation explain shows disk thresholds:\n1. Check disk usage on data nodes.\n2. Free space by deleting old indices:\n- Daily indices: `products-v3-YYYY.MM.DD`\n- Retention: 14 days\n`bash\ncurl -s -X GET 'http://localhost:9200/_cat/indices/products-v3-*?h=index,store.size,docs.count'\ncurl -s -X DELETE 'http://localhost:9200/products-v3-2025.09.*'\n`\n3. If retention is already enforced, check ILM policy `products-ilm-v3` for failures.\n\n## B) Unassigned primaries after node restart\n1. Confirm node count and pod status.\n`bash\nkubectl -n ecommerce-prod get pods -l app=elasticsearch\n`\n2. If a data node is crashlooping, identify OOM:\n- Check events: `OOMKilled`\n- Consider increasing memory limits (typical: 8Gi -> 12Gi)\n\n## C) Threadpool rejections (429)\nIf you see `es_rejected_execution_exception`:\n1. Reduce search concurrency by enabling circuit breaker in search-api:\n- Env var: `SEARCH_MAX_CONCURRENCY=40` (default 80)\n2. Temporarily disable expensive features:\n- `SEARCH_ENABLE_AGGS=false`\n- `SEARCH_ENABLE_SPELLCHECK=false`\n3. Validate CPU saturation on data nodes.\n\n## D) Indexing runaway\nIf indexing-worker is flooding ES:\n1. Pause consumer group by scaling workers to 0.\n`bash\nkubectl -n ecommerce-prod scale deploy/indexing-worker --replicas=0\n`\n2. Let ES recover.\n3. Resume with lower batch size:\n- `INDEXING_BULK_SIZE=250` (default 1000)\n\n# Recovery\n## Validate green state\n- Cluster health green for 10+ minutes\n- search-api p95 < 250ms\n- No unassigned shards\n\n## Re-enable features\nUndo any temporary flags gradually.\n\n# Edge cases\n- **Mapping explosions**: a product attribute field can become dynamic and create thousands of fields. Symptom: `Limit of total fields [1000] has been exceeded`.\n  - Fix: block dynamic mapping in template `products-template-v3`.\n- **Analyzer mismatch after deploy**: search-api might query a field that changed name. Symptom: `query_shard_exception: failed to find field`.\n  - Fix: deploy index alias compatibility or rollback.\n- **Split brain warnings**: if master pods flap, you may see `master_not_discovered_exception`. In that case, do not force allocate shards until masters stabilize.\n\n# Useful commands\n- Cat shards:\n`bash\ncurl -s 'http://localhost:9200/_cat/shards?v'\n`\n- Hot threads:\n`bash\ncurl -s 'http://localhost:9200/_nodes/hot_threads?pretty'\n`\n\n# Related docs\n- ADR-2025-02: Index aliasing strategy for products\n- PM-2025-12: ES disk watermark incident\n",
  "language": "en"
}