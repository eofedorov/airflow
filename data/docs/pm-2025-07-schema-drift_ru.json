{
  "doc_key": "pm-2025-07-schema-drift",
  "title": "Постмортем PM-2025-07: деплой checkout-service сломался из-за не примененной миграции",
  "doc_type": "postmortem",
  "created_at": "2025-07-19",
  "content": "# Summary\n2025-07-18 задеплоили checkout-service v2.9.0, который ожидал колонку orders.applied_promotions. Миграция Alembic не применилась (джоба упала), но promote пайплайн не зафейлился. Новые поды начали отдавать 500 с UndefinedColumn.\n\n# Impact\n- 2025-07-18 14:03–14:24 UTC\n- POST /api/checkout/start: ~68 процентов 500\n- GET /api/checkout/orders/{id}: 500 для заказов, созданных в окне\n\n# Detection\n- Checkout5xxSpike\n- Логи: psycopg.errors.UndefinedColumn: column orders.applied_promotions does not exist\n\n# Timeline\n- 14:03 promote завершился\n- 14:05 алерт\n- 14:10 откат на v2.8.3\n- 14:18 ручной запуск миграции\n- 14:24 стабилизация\n\n# Root cause\nМиграционная джоба использовала application DATABASE_URL, который указывает на PgBouncer. PgBouncer работает в transaction pooling (ADR-2024-08). Миграция использовала advisory lock и ожидала session-level стабильность. Джоба завершилась с non-zero.\n\nДальше два усугубляющих решения:\n- шаг миграции в promote был continue-on-error=true\n- не было проверки что alembic head действительно применен\n\nВ итоге деплой продолжился, код начал обращаться к несуществующей колонке.\n\n# Contributing factors\n- В staging миграции ходили напрямую в primary, поэтому проблему не поймали.\n- Логи миграции не отображались в сводке promote.\n- Не было preflight проверки схемы.\n\n# Resolution\n- Откат rollout\n- Ручной запуск миграций против primary Postgres:\n`bash\nkubectl -n ecommerce-prod create job --from=cronjob/checkout-migrations checkout-migrations-manual\nkubectl -n ecommerce-prod logs job/checkout-migrations-manual\n`\n- Проверка наличия колонки:\n`sql\nselect column_name from information_schema.columns where table_name='orders' and column_name='applied_promotions';\n`\n\n# Что было хорошо\n- Откат прошел быстро\n- Диагноз был очевиден по логам\n\n# Что было плохо\n- Пайплайн скрывал ошибку миграции\n- Нарушили собственную ADR про миграции мимо PgBouncer\n\n# Action items\n1) Убрать continue-on-error из миграционного шага\n2) Добавить gate: alembic current == head\n3) Ввести DATABASE_URL_PRIMARY для миграций во всех средах\n4) Добавить в promote вывод логов миграций в summary\n5) Обновить онбординг CI/CD и чеклист прод-деплоя\n\n# Нюанс\nИногда миграции случайно проходят через PgBouncer и кажется что это работает. Но любая миграция, зависящая от session state, может падать нестабильно. Дебаг такого поведения дороже, чем явное правило: миграции всегда через primary.\n\n# Ссылки\n- ADR-2024-08\n- RB-2025-06",
  "language": "ru"
}