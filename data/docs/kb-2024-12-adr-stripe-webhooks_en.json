{
  "doc_key": "kb-2024-12-adr-stripe-webhooks",
  "title": "ADR-2024-12: Stripe Webhooks as Source of Truth for Payment State",
  "doc_type": "adr",
  "created_at": "2024-12-15",
  "content": "# Status\nAccepted\n\n# Context\nWe integrate Stripe for card payments and refunds. Historically, checkout-service polled Stripe for PaymentIntent status, which caused:\n- Increased API cost and throttling during traffic spikes\n- Race conditions when polling lagged behind actual status\n- Complex retry logic across services\n\nWe already have a legacy Node **payment-gateway** that receives Stripe webhook events, but its handler was previously treated as best-effort and not authoritative.\n\n# Decision\nMake **Stripe webhooks** the authoritative source of payment state. Specifically:\n- **payment-gateway** will validate webhook signatures and persist raw event payloads (minimally) in Postgres`stripe_events`.\n- **checkout-service** will update `payments.payment_status`based on processed events only.\n- Polling will remain as a fallback only for reconciliation jobs (daily) and for manual support tools.\n\n# Technical details\n## Stripe API version\nPin Stripe API version in payment-gateway to`2023-10-16`to keep event shape stable.\n\n## Webhook endpoint\n- Route:`POST /webhooks/stripe`\n- Must use raw body to validate signature.\n\n## Signature verification\n- Env var: `STRIPE_WEBHOOK_SECRET`\n- Reject if signature invalid. Log sample:\n  - `StripeSignatureVerificationError: No signatures found matching the expected signature`\n\n## Idempotency\n- Store `event.id`(e.g.,`evt*...`) in `stripe_events.event_id`(unique).\n- Before processing, check existence.\n\n## Processing pipeline\n1. Receive event and persist to`stripe_events`.\n2. Enqueue internal job `process_stripe_event(event_id)`.\n3. Update `payments`and`orders`tables in a transaction.\n\nSchema (proposed):\n```sql\ncreate table stripe_events (\n  event_id text primary key,\n  type text not null,\n  created_at timestamptz not null default now(),\n  payload jsonb not null,\n  processed_at timestamptz\n);\n```\n\n# Consequences\n## Positive\n- Lower Stripe API usage and fewer throttling errors\n- Single consistent state transition mechanism\n- Better auditability (raw events stored)\n\n## Negative / risks\n- If webhook handler breaks, payment state stalls (orders remain pending).\n- Requires strict operational runbook (see RB-2026-01 stripe webhook backlog).\n- Event order is not guaranteed; code must handle out-of-order events.\n\n# Alternatives considered\n## A) Continue polling\nRejected due to cost and complexity.\n\n## B) Stripe events to Kafka\nDeferred. Would add infrastructure and operational overhead; revisit when we migrate payment-gateway to Python.\n\n# Notes\nThis ADR assumes Postgres availability for event persistence. If Postgres is down, payment-gateway should return 500 to force Stripe retries (do not ack without persistence).\n",
  "language": "en"
}