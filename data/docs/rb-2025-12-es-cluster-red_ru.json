{
  "doc_key": "rb-2025-12-es-cluster-red",
  "title": "Ранбук: Elasticsearch red/yellow и деградация поиска",
  "doc_type": "runbook",
  "created_at": "2025-12-03",
  "content": "# Кратко\nРанбук для ситуаций, когда Elasticsearch кластер становится yellow/red, появляются unassigned shards, растут 429 es_rejected_execution_exception, или индексирование отстает, и search-api начинает отдавать 503 SEARCH_UNAVAILABLE.\n\nСервисы: search-api, indexing-worker\n\nСтек: Elasticsearch 8.11.3 (3 master-eligible + 6 data nodes), индексы products-v3-*, алиас products_read (ADR-2025-02)\n\n# Норма\n- Cluster health green\n- search-api p95 120–220мс\n- Threadpool search/write очереди близко к 0\n- Kafka lag по catalog.product.changed < 50к и быстро догоняет\n- Диски data-node < 70 процентов\n\n# Симптомы\nsearch-api:\n- ConnectionTimeout\n- 429 es_rejected_execution_exception\n- index_not_found_exception: no such index [products_read]\n\nindexing-worker:\n- BulkIndexError: N documents failed\n- mapper_parsing_exception по attributes.*\n\n# Где смотреть\nGrafana:\n- Search / search-api\n- Platform / Elasticsearch / Cluster\n- Indexing / Kafka Lag\n\nАлерты:\n- ElasticsearchClusterRed\n- ElasticsearchDiskHighWatermark\n- SearchApi503Spike\n\n# Быстрый триаж\n1) Health:\n`bash\nkubectl -n ecommerce-prod port-forward svc/elasticsearch 9200:9200\ncurl -s http://localhost:9200/_cluster/health?pretty\n`\n2) Allocation explain:\n`bash\ncurl -s http://localhost:9200/_cluster/allocation/explain?pretty\n`\n3) Проверить алиас:\n`bash\ncurl -s http://localhost:9200/_cat/aliases/products_read?v\n`\n4) Threadpool:\n`bash\ncurl -s http://localhost:9200/_cat/thread_pool/search?v\ncurl -s http://localhost:9200/_cat/thread_pool/write?v\n`\n\n# Митигирующие действия\n## A: Disk watermark и unassigned shards\nЕсли причина disk_threshold:\n- Посмотреть старые индексы:\n`bash\ncurl -s 'http://localhost:9200/_cat/indices/products-v3-*?h=index,store.size,docs.count&s=index'\n`\n- Удалить явно устаревшие (ретеншн 14 дней). Важно: не удалить индекс, на который указывает products_read.\n`bash\ncurl -s 'http://localhost:9200/_cat/aliases/products_read?h=index'\ncurl -s -X DELETE 'http://localhost:9200/products-v3-2025.0*'\n`\nЕсли ILM сломан и не чистит, ручное удаление допустимо во время инцидента, но потом нужно восстановить ILM.\n\n## B: 429 и перегруз\nВключить деградацию в search-api:\n- SEARCH_ENABLE_AGGS=false\n- SEARCH_ENABLE_SPELLCHECK=false\n- SEARCH_MAX_CONCURRENCY=40 (вместо 80)\n`bash\nkubectl -n ecommerce-prod set env deploy/search-api SEARCH_ENABLE_AGGS=false SEARCH_ENABLE_SPELLCHECK=false SEARCH_MAX_CONCURRENCY=40\n`\nПараллельно уменьшить давление от индексатора.\n\n## C: Индексатор разогнал write\nЕсли lag огромный и write queue растет:\n- Пауза indexing-worker:\n`bash\nkubectl -n ecommerce-prod scale deploy/indexing-worker --replicas=0\n`\n- После стабилизации вернуть 1 реплику и меньший bulk:\n  - INDEXING_BULK_SIZE=250 (вместо 1000)\n  - INDEXING_FLUSH_INTERVAL_MS=750 (вместо 250)\n\n## D: Несовместимость mapping после деплоя\nЕсли search-api стал запрашивать поле, которого нет, или тип поменялся:\n- Быстро откатить search-api на совместимую версию\n- Либо временно вернуть products_read на старый индекс (атомарный switch алиаса):\n`bash\ncurl -s -X POST http://localhost:9200/_aliases -H 'Content-Type: application/json' -d '{\n  \"actions\": [\n    {\"remove\": {\"alias\": \"products_read\", \"index\": \"products-v3-2025.02.06\"}},\n    {\"add\": {\"alias\": \"products_read\", \"index\": \"products-v3-2025.01.30\"}}\n  ]\n}'\n`\nЕсли мешают двойные кавычки в примере, можно выполнить тот же запрос из файла.\n\n# Восстановление\n- Health green 10+ минут\n- search-api p95 < 250мс\n- Kafka lag по индексации начинает падать\n\nВозвращать indexing-worker постепенно: 1 реплика, маленький bulk, затем scale.\n\n# Острые углы\n- Hot shard: кластер зеленый, но один shard перегружен (популярная категория). Смотреть _cat/shards.\n- Master instability: master_not_discovered_exception. Не делайте ручной allocation до стабилизации мастеров.\n- Merge storm: слишком агрессивная индексация вызывает CPU spikes и замедляет поиск.\n- Type conflicts: attributes.size как строка в одних товарах и число в других приведет к mapper_parsing_exception.\n\n# Ссылки\n- ADR-2025-02 стратегия алиасов\n- API search-api v3\n- CL-2025-10 еженедельный ops чеклист (ILM/ретеншн)",
  "language": "ru"
}