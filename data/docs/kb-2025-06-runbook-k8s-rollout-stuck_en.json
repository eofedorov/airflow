{
  "doc_key": "kb-2025-06-runbook-k8s-rollout-stuck",
  "title": "Runbook: Kubernetes Rollout Stuck / CrashLoopBackOff (FastAPI services)",
  "doc_type": "runbook",
  "created_at": "2025-06-21",
  "content": "# Summary\nA deployment rollout can stall due to readiness probe failures, CrashLoopBackOff, or image pull errors. This runbook focuses on FastAPI services (checkout-service, cart-service, search-api) in `ecommerce-prod`.\n\n# Common causes\n- Wrong env vars or missing secrets\n- DB migration mismatch (alembic head not applied)\n- Redis/Elasticsearch DNS issues\n- Readiness probe misconfigured (path or port)\n- OOMKilled due to increased memory usage\n\n# Triage checklist\n## 1) Identify rollout status\n`bash\nkubectl -n ecommerce-prod rollout status deploy/checkout-service\nkubectl -n ecommerce-prod get pods -l app=checkout-service -o wide\n`\nIf it says `waiting for rollout to finish`, inspect failing pods.\n\n## 2) Describe the pod\n`bash\nkubectl -n ecommerce-prod describe pod <pod-name>\n`\nLook for:\n- `ImagePullBackOff`\n- `OOMKilled`\n- `Readiness probe failed`\n- `Back-off restarting failed container`\n\n## 3) Check logs\n`bash\nkubectl -n ecommerce-prod logs <pod-name> --previous\nkubectl -n ecommerce-prod logs <pod-name>\n`\nCommon FastAPI startup failures:\n- `sqlalchemy.exc.OperationalError: could not connect to server: Connection refused`\n- `alembic.util.exc.CommandError: Can't locate revision identified by '...'\n- `pydantic_core.*pydantic_core.ValidationError: 1 validation error for Settings`\n\n# Mitigation by scenario\n## A) Readiness probe failures\nExpected readiness path: `/health/ready`(returns 200 JSON:`{ 'status': 'ok' }`).\n1. Verify probe config:\n- port `8080`\n- initialDelaySeconds `10`\n- timeoutSeconds `2`\n2. Exec into pod and curl locally:\n```bash\nkubectl -n ecommerce-prod exec -it <pod-name> -- sh\nwget -qO- http://127.0.0.1:8080/health/ready\n```\nEdge case: service starts but waits for dependent check (Postgres/Redis). If Redis is down, readiness will fail by design unless `READINESS_STRICT_DEPS=false`.\n\n## B) Missing secrets/config\nSettings are validated at startup. If a required var is missing, pydantic raises.\n1. Compare env var set with expected list in `docs/config/service-env.md`.\n2. Confirm secret exists:\n```bash\nkubectl -n ecommerce-prod get secret checkout-service-secrets\n```\n3. If secret key renamed, roll back or patch.\n\n## C) DB migration mismatch\nIf the container expects a new schema but migrations werenâ€™t applied:\n- Symptom: app crashes on import with missing column.\n- Example: `psycopg.errors.UndefinedColumn: column orders.payment_provider does not exist`\nActions:\n1. Stop the rollout by scaling replicas to previous version (or rollback):\n```bash\nkubectl -n ecommerce-prod rollout undo deploy/checkout-service\n```\n2. Apply migrations via the migration job:\n```bash\nkubectl -n ecommerce-prod create job --from=cronjob/checkout-migrations checkout-migrations-manual\n```\n3. Re-deploy.\n\n## D) OOMKilled\n1. Identify memory usage increase via Grafana: **K8s / Pod Memory**.\n2. Temporarily raise limits:\n- Typical for checkout-service: requests 300Mi, limits 800Mi.\n3. If recent change enabled debug logging or loaded large models, rollback.\n\n## E) ImagePullBackOff\n1. Check image tag exists in registry.\n2. Confirm imagePullSecret is present.\n3. If GitHub Actions pushed to wrong repo, fix pipeline.\n\n# Recovery validation\n- Rollout completes.\n- Error rate stable.\n- p95 latency returns to baseline.\n\n# Edge cases\n- **Partial rollouts**: some pods ready, some failing. This can cause mixed behavior (new code path expects new Redis keys). Prefer rollback quickly.\n- **Stuck terminating**: old ReplicaSet pods hanging due to long shutdown. Increase `terminationGracePeriodSeconds`or fix`lifespan`handlers.\n- **Readiness vs liveness confusion**: do not point liveness at external dependency checks; use a local-only endpoint.\n\n# Related docs\n- Checklist: Production deploy checklist (CL-2025-09-prod-deploy)\n- Postmortem: PM-2025-07-migrations-caused-outage\n",
  "language": "en"
}