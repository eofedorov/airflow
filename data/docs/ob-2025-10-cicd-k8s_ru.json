{
  "doc_key": "ob-2025-10-cicd-k8s",
  "title": "Онбординг: CI/CD и Kubernetes конвенции (GitHub Actions + Docker + K8s)",
  "doc_type": "onboarding",
  "created_at": "2025-10-12",
  "content": "# Обзор\nДокумент про то, как изменения попадают в прод и как дебажить проблемы CI/деплоя. Это не учебник по K8s, а наши конкретные правила.\n\n# Окружения\n- staging: namespace ecommerce-staging, host staging-api.company.tld\n- prod: namespace ecommerce-prod, host api.company.tld\n\n# Образы\nКонвенция:\n- <service>:<git-sha>\n- <service>:v<semver>\nЗапрещено деплоить latest.\n\nПример: checkout-service:9f2c1a3, checkout-service:v2.14.0\n\n# GitHub Actions\nКаждый сервис:\n- ci.yml (PR)\n- release.yml (теги)\nПлатформа:\n- promote.yml (промоут в прод)\n\nТиповые шаги:\n- lint (ruff 0.4.x)\n- pytest\n- docker buildx\n- push в registry\n\n# Процесс деплоя\n1) merge в main -> auto deploy в staging\n2) smoke тесты\n3) запуск promote.yml с SHA\n4) мониторинг rollout + метрики 15 минут\n\n# K8s конвенции\n- liveness: /health/live (без внешних зависимостей)\n- readiness: /health/ready (может проверять БД, но осторожно)\n\nПорты:\n- FastAPI 8080 в контейнере\n- payment-gateway 8090\n\n# Дебаг деплоя\nБыстрый набор команд:\n`bash\nkubectl -n ecommerce-prod rollout status deploy/cart-service\nkubectl -n ecommerce-prod get pods -l app=cart-service\nkubectl -n ecommerce-prod describe pod <pod>\nkubectl -n ecommerce-prod logs <pod> --previous\n`\nЕсли rollout завис, см. RB-2025-06.\n\n# Миграции\nКритично: миграции должны ходить в primary Postgres, не через PgBouncer (ADR-2024-08, PM-2025-07).\nЕсли деплой добавляет колонку, и миграция не выполнилась, получите UndefinedColumn и CrashLoop.\n\n# Observability\n- /metrics для Prometheus\n- X-Request-Id в логах\n\nМинимальные дашборды после деплоя:\n- latency + 5xx\n- Postgres numbackends\n- Redis evicted_keys (если трогали кеш)\n- Stripe webhook queue (если трогали payment-gateway)\n- ES health (если трогали search)\n\n# Грабли\n- Partial rollout секретов Stripe: часть подов валит invalid_signature\n- Смена формата Redis ключей: резкий cache miss и рост нагрузки на БД\n- Алиас products_read отсутствует: search-api уходит в 503\n\n# Локальный k8s (опционально)\nkind:\n`bash\nkind create cluster --name ecommerce-dev\nkubectl create ns ecommerce-dev\nkubectl -n ecommerce-dev apply -f infra/k8s/dev/\n`\nЕсли ImagePull проблемы, загрузите локальный образ в kind.\n\n# Рекомендация по rollback\nЕсли после деплоя сразу пошел всплеск 5xx, rollback первым действием, дебаг вторым.\n`bash\nkubectl -n ecommerce-prod rollout undo deploy/checkout-service\n`\n\n# Ссылки\n- CL-2025-09 прод-чеклист\n- RB-2024-11 Postgres connections\n- RB-2026-02 Redis eviction\n- RB-2026-01 Stripe webhook backlog",
  "language": "ru"
}