{
  "doc_key": "rb-2026-02-redis-evictions",
  "title": "Runbook: Redis Evictions and Cart/Checkout Inconsistency",
  "doc_type": "runbook",
  "created_at": "2026-02-02",
  "content": "# Summary\nThis runbook covers incidents where Redis cache behavior (evictions, latency, replica lag, or outright unavailability) causes inconsistent cart behavior and checkout failures. The most common pattern is a spike in `409 CART_VERSION_MISMATCH` and `412 PRECONDITION_FAILED` during `/api/checkout/start`, paired with `redis_evicted_keys_total` increasing and `cart-service` cache miss ratio > 0.85.\n\n**Primary services:** cart-service, checkout-service  \n**Primary dependency:** Redis (clustered, Redis 7.2.4)  \n**Source of truth:** Postgres (carts + cart_items)\n\n# What “normal” looks like\n- cart-service p95 latency: 80–140ms\n- checkout-service `http_409_total` near zero\n- Redis:\n  - `used_memory / maxmemory` < 0.75\n  - `evicted_keys` flat (0/min)\n  - `instantaneous_ops_per_sec` stable (no saw-tooth)\n- Cart cache:\n  - average value size 10–40KB\n  - TTL 900s (`CART_CACHE_TTL_SECONDS=900`)\n\n# Symptoms\n## User-facing\n- Cart page “drops” items after refresh (usually from a different session/device)\n- Checkout page loops: “Something changed in your cart. Please retry.”\n- Payment attempts stuck in pending due to cart snapshot mismatch\n\n## Service logs / errors\ncart-service:\n- `redis.exceptions.ConnectionError: Error 111 connecting to redis.ecommerce-prod.svc:6379. Connection refused`\n- `CacheWriteSkipped size_bytes=221332 reason=value_too_large`\n- `cart_etag_source=redis etag_reset=true`\n\ncheckout-service:\n- `CartPreconditionFailed: missing If-Match`\n- `CART_VERSION_MISMATCH expected=18 got=17 cart_id=...`\n\n# Dashboards and alerts\nGrafana folders:\n- **Platform / Redis / Cache Health**\n- **cart-service / Cache + DB**\n- **checkout-service / Funnel**\n\nPrometheus alert rules (names as in `infra/observability/alerts.yml`):\n- `RedisEvictionsHigh`: `increase(redis_evicted_keys_total[5m]) > 500`\n- `CartVersionMismatchSpike`: `rate(http_responses_total{service=\"checkout-service\",status=\"409\"}[5m]) > 5`\n\n# Fast triage (5 minutes)\n1. Confirm incident scope:\n   - Is it only carts/checkout, or are other Redis-backed features failing (rate-limits, Stripe idempotency, sessions)?\n2. Check Redis health:\n   ```bash\n   kubectl -n ecommerce-prod port-forward svc/redis 6379:6379\n   redis-cli -p 6379 INFO memory | egrep 'used_memory_human|maxmemory_human|mem_fragmentation_ratio'\n   redis-cli -p 6379 INFO stats | egrep 'evicted_keys|keyspace_hits|keyspace_misses'\n   redis-cli -p 6379 CLUSTER INFO\n   ```\n3. Check cart cache miss + value size:\n   - cart-service metric: `cart_cache_value_size_bytes{p95}`\n   - If not available, use debug header (only on staging by default):\n     - `X-Debug-Cache-Key: cart:{user_id}:v{version}`\n     - `X-Debug-Cache-Bytes: <int>`\n4. Check recent deploys:\n   - If cart-service was deployed in the last 60 minutes, search the diff for changes to cart serialization, recommendations, or TTL logic.\n\n# Mitigation options\nPick the least risky option that stops user-visible failures.\n\n## Mitigation A: Bypass Redis for cart reads (preferred during evictions)\nEnable a temporary bypass so cart-service reads from Postgres and does not write back.\n- Env:\n  - `CART_CACHE_BYPASS=true`\n  - `CART_CACHE_WRITEBACK=false`\n```bash\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_BYPASS=true CART_CACHE_WRITEBACK=false\nkubectl -n ecommerce-prod rollout status deploy/cart-service\n```\n**Trade-off:** Postgres load increases. Watch `pg_stat_activity` and checkout latency.\n\n## Mitigation B: Reduce cart cache TTL and cap cache payload\nIf Redis is healthy but memory is near max:\n- Reduce TTL: `CART_CACHE_TTL_SECONDS=120`\n- Enforce payload cap: `CART_CACHE_MAX_BYTES=131072` (128KB)\n```bash\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_TTL_SECONDS=120 CART_CACHE_MAX_BYTES=131072\n```\n**Note:** If the cap is enabled, large carts will skip caching; that’s okay. It is better than thrashing Redis.\n\n## Mitigation C: Stabilize ETag derivation\nIf checkout failures are primarily 409s:\n- Switch ETag source from cached payload to Postgres snapshot:\n  - `CART_ETAG_SOURCE=postgres`\n- Additionally allow checkout-service to retry once:\n  - `CHECKOUT_RETRY_ON_CART_MISMATCH=true` (temporary)\n```bash\nkubectl -n ecommerce-prod set env deploy/checkout-service CART_ETAG_SOURCE=postgres CHECKOUT_RETRY_ON_CART_MISMATCH=true\n```\n\n## Mitigation D: Free Redis memory (last resort)\nIf you must free memory quickly:\n1. Identify large keys (slow; do not run during peak unless necessary):\n   ```bash\n   redis-cli -p 6379 --scan --pattern 'cart:*' | head -n 2000 | \\\n     xargs -n 50 redis-cli -p 6379 MEMORY USAGE\n   ```\n2. Delete only the largest offenders (usually carts with embedded metadata):\n   ```bash\n   redis-cli -p 6379 --scan --pattern 'cart:*' | head -n 500 | \\\n     xargs -n 50 redis-cli -p 6379 DEL\n   ```\n**Warning:** This can amplify DB load and worsen checkout for a few minutes.\n\n# Recovery and verification\n1. Metrics should stabilize:\n   - `redis_evicted_keys_total` flat\n   - cart-service cache miss ratio < 0.5 (after re-enable)\n   - checkout-service 409 rate returns to baseline\n2. Re-enable cache gradually:\n   - First allow reads (writes disabled), then writeback:\n```bash\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_BYPASS=false CART_CACHE_WRITEBACK=false\n# wait 10–15 minutes\nkubectl -n ecommerce-prod set env deploy/cart-service CART_CACHE_WRITEBACK=true CART_CACHE_TTL_SECONDS=900\n```\n3. Validate with a real flow (staging if possible):\n   - Add item, remove item, checkout start, ensure totals match.\n\n# Edge cases and “gotchas”\n- **Replica lag:** if Redis reads are served from replicas and replication lags, ETag can regress. Symptom: “version goes backwards.” Confirm `role:slave` INFO replication and `master_link_status=up`. If lag > 1s, force reads from masters temporarily.\n- **Key format mismatch after deploy:** if key prefix changed (e.g., `cart2:` vs `cart:`), you’ll see near-100% misses but no evictions. Roll back or add compatibility read path.\n- **Large carts (>200 items):** serialization can exceed 256KB and trigger timeouts. cart-service should log `CacheWriteSkipped reason=value_too_large`.\n- **Thundering herd on rehydrate:** after bypass ends, thousands of carts repopulate at once. Consider jittered TTL (`CART_CACHE_TTL_JITTER_SECONDS=120`) to avoid synchronized expirations.\n- **Ingress retries:** if the client or gateway retries `POST /api/cart/.../items` without idempotency keys, duplicate increments happen. Verify `Idempotency-Key` usage in clients.\n\n# References\n- ADR-2025-03 Redis as primary cache for carts\n- PM-2025-11 Redis OOM and evictions broke checkout consistency\n- Checklist CL-2025-09 Production deploy (watch Redis evictions on cache changes)",
  "language": "en"
}