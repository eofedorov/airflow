{
  "doc_key": "api-2025-11-checkout-v2",
  "title": "API Spec: checkout-service Public API (v2)",
  "doc_type": "api_spec",
  "created_at": "2025-11-18",
  "content": "# API Spec: checkout-service Public API (v2)\n\n## Overview\ncheckout-service orchestrates checkout, order creation, and payment initiation via payment-gateway. It reads cart state from cart-service and persists orders/payments in Postgres. Payment completion is driven by Stripe webhooks (ADR-2024-12).\n\nBase path: `/api/checkout`  \nService: `checkout-service` (FastAPI 0.110)  \nAuth: Bearer token required for all endpoints\n\n## Headers\n### Request\n- `Authorization: Bearer <jwt>`\n- `Idempotency-Key: <uuid>` (required for `/start` and refund endpoints)\n- `X-Request-Id` (optional)\n\n### Response\n- `X-Request-Id`\n- `Retry-After` (optional; when returning 503 due to provider outage)\n\n## Error format\n```json\n{ \"error_code\": \"CODE\", \"message\": \"Text\", \"request_id\": \"...\" }\n```\nCommon error codes:\n- `CART_VERSION_MISMATCH` (409)\n- `PRICE_CHANGED` (409)\n- `ADDRESS_INVALID` (422)\n- `PAYMENT_PROVIDER_UNAVAILABLE` (503)\n- `PAYMENT_PENDING_TIMEOUT` (409; pending too long)\n- `ORDER_NOT_FOUND` (404)\n- `ORDER_ALREADY_PAID` (409)\n\n## State model\norders.status:\n- `DRAFT` (rare; internal)\n- `PAYMENT_PENDING`\n- `PAID`\n- `FULFILLING`\n- `FULFILLED`\n- terminal failures: `PAYMENT_FAILED`, `CANCELLED`\n\npayments.payment_status:\n- `PENDING`, `SUCCEEDED`, `FAILED`, `CANCELED`, `REFUNDED`\n\n## Endpoints\n### POST /api/checkout/start\nCreates an order and returns a Stripe client secret.\n\nHeaders:\n- `Idempotency-Key` required\n\nRequest body:\n```json\n{\n  \"user_id\": \"uuid\",\n  \"cart_id\": \"uuid\",\n  \"shipping_address_id\": \"uuid\",\n  \"billing_address_id\": \"uuid\",\n  \"currency\": \"USD\"\n}\n```\n\nProcessing notes:\n1. Calls cart-service `GET /api/cart/{user_id}` and validates ETag.\n2. Reprices items via pricing rules (internal module, not a service call).\n3. Persists order + payment rows in a single DB transaction.\n4. Calls payment-gateway internal endpoint to create PaymentIntent.\n\nSuccess response 201:\n```json\n{\n  \"order_id\": \"uuid\",\n  \"status\": \"PAYMENT_PENDING\",\n  \"payment\": {\n    \"provider\": \"stripe\",\n    \"payment_intent_id\": \"pi_...\",\n    \"client_secret\": \"pi_..._secret_...\"\n  }\n}\n```\n\nFailure responses:\n- 409 `CART_VERSION_MISMATCH`: cart changed after UI loaded; client must refetch cart and retry.\n- 409 `PRICE_CHANGED`: totals differ after repricing; client must refresh totals before retry.\n- 503 `PAYMENT_PROVIDER_UNAVAILABLE`: payment-gateway timed out or returned error. Response includes `retry_after_seconds`.\n\nEdge case: if payment-gateway times out but Stripe created the intent, idempotency ensures we return the same intent on retry. If idempotency is broken, you’ll see duplicate PaymentIntents in Stripe.\n\n### GET /api/checkout/orders/{order_id}\nReturns order details and current status.\n\nResponse 200 includes:\n- order totals\n- payment status\n- timestamps (created_at, updated_at)\n\n### GET /api/checkout/orders/{order_id}/status\nLightweight status endpoint for polling UI:\n```json\n{ \"order_id\": \"...\", \"status\": \"PAYMENT_PENDING\", \"payment_status\": \"PENDING\" }\n```\nThis endpoint is cached for 2 seconds at the edge; do not use for data correctness.\n\n### POST /api/checkout/orders/{order_id}/cancel\nCancels an unpaid order.\n\nRules:\n- If payment_status is `SUCCEEDED`, return 409 `ORDER_ALREADY_PAID`.\n- If payment is still pending and older than 10 minutes, cancel is allowed and marks order `CANCELLED`.\n\n### POST /api/checkout/orders/{order_id}/refund\nRequests a refund (partial or full). Used by support tooling (requires elevated scopes in JWT).\n\nHeaders:\n- `Idempotency-Key` required\n\nRequest:\n```json\n{ \"amount_minor\": 2780, \"reason\": \"customer_request\" }\n```\n\nResponse:\n- 202 accepted (refund is asynchronous)\n- refund completion is driven by Stripe events and refund-reconciler\n\n## Idempotency details\n- For `/start`, `Idempotency-Key` is stored in Postgres `checkout_idempotency` with unique constraint `(user_id, key)`.\n- Replaying the key returns the same `order_id` and `client_secret` if the original request succeeded.\n- If the same key is replayed with different cart_id or address_id, return 409 `IDEMPOTENCY_KEY_REUSE`.\n\n## Observability\nKey metrics:\n- `checkout_start_total{status}`\n- `checkout_cart_mismatch_total`\n- `payment_provider_errors_total`\n- `orders_payment_pending_total`\n\nLog fields:\n- `order_id`, `user_id`, `cart_id`, `stripe_payment_intent_id`, `request_id`\n\n## Edge cases and nuances\n- **Pending too long:** If `PAYMENT_PENDING` exceeds 10 minutes, UI can show a “Check payment” button; backend may return `PAYMENT_PENDING_TIMEOUT` to trigger support flow.\n- **Out-of-order Stripe events:** payment can succeed after we cancelled due to timeout. Our processor must prefer success and then trigger refund if needed; this is rare but real in retries.\n- **Currency mismatch:** We reject orders if cart currency differs from request currency (422 `CURRENCY_MISMATCH`), but some older clients omit currency; default is USD.\n- **Cart 304:** cart-service may return 304 Not Modified; checkout-service must still read latest persisted cart snapshot to avoid trusting stale UI totals.\n\n## Related docs\n- ADR-2024-12 Stripe webhooks\n- Runbook: Stripe webhook backlog\n- Onboarding: Payments flow",
  "language": "en"
}