{
  "doc_key": "kb-2025-02-adr-es-aliasing",
  "title": "ADR-2025-02: Elasticsearch Index Aliasing and Zero-Downtime Reindexing for Products",
  "doc_type": "adr",
  "created_at": "2025-02-06",
  "content": "# Status\nAccepted\n\n# Context\nWe need to evolve product search mappings (new analyzers, fields) without downtime. Directly updating mappings is limited, and reindexing can take hours for 30M docs.\n\n# Decision\nAdopt an index aliasing strategy:\n- Write alias: `products_write`\n- Read alias: `products_read`\n- Concrete indices: `products-v3-YYYY.MM.DD`\n\nReindex flow:\n1. Create new index with updated template.\n2. Bulk reindex from Postgres snapshot (or existing index).\n3. Atomically switch read alias.\n4. Switch write alias after dual-write validation.\n\n# Technical details\n## Index templates\nTemplate name: `products-template-v3`\n- Dynamic mapping: disabled for `attributes.*`to avoid field explosion.\n-`total_fields.limit`: 1000\n\nExample template snippet:\n```json\n{\n  \"index_patterns\": [\"products-v3-*\"]\n}\n```\n\n## Dual write\nindexing-worker publishes to both old and new indices for 30 minutes.\n- Env var: `INDEX_DUAL_WRITE=true`\n\n## Aliasing commands\n```bash\ncurl -X POST localhost:9200/_aliases -H 'Content-Type: application/json' -d '{\n  \"actions\": [\n    {\"remove\": {\"alias\": \"products_read\", \"index\": \"products-v3-2025.01.30\"}},\n    {\"add\": {\"alias\": \"products_read\", \"index\": \"products-v3-2025.02.06\"}}\n  ]\n}'\n```\n\n# Consequences\n## Positive\n- Zero downtime mapping changes\n- Safer rollback (repoint alias)\n\n## Negative\n- Higher storage usage during reindex windows\n- Operational complexity during dual write\n\n# Alternatives\n- Use a single rolling index with ILM only: rejected; mapping changes still require reindex.\n\n# Edge cases\n- If a node is under disk watermark, alias switch wonâ€™t fix unassigned shards.\n- If search-api uses field names removed in new mapping, queries can fail with `failed to find field`.\n\n# References\n- Runbook: RB-2025-10 ES cluster red\n",
  "language": "en"
}