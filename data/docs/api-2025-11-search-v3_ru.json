{
  "doc_key": "api-2025-11-search-v3",
  "title": "API Spec: search-api Public API (v3)",
  "doc_type": "api_spec",
  "created_at": "2025-11-22",
  "content": "# Обзор\nsearch-api предоставляет поиск товаров поверх Elasticsearch. Индексы меняются через алиасы (ADR-2025-02). Во время reindex результаты могут слегка отличаться, но контракт API стабилен.\n\nBase path: /api/search\nAuth: опционально (анонимный поиск разрешен), JWT нужен для персонализации\n\n# Заголовки\nRequest:\n- X-Request-Id (опционально)\n- Accept-Language (опционально)\n\nResponse:\n- X-Request-Id\n- X-Search-Degraded: true|false\n\n# Ошибки\n`json\n{ 'error_code': 'CODE', 'message': 'text', 'request_id': '...' }\n`\nКоды:\n- INVALID_FILTER (400)\n- INVALID_SORT (400)\n- SEARCH_UNAVAILABLE (503)\n- SEARCH_RATE_LIMITED (429)\n\n# Endpoints\n## GET /api/search/products\nQuery:\n- q string (пусто = trending)\n- page int default 1\n- page_size int default 24 max 100\n- filters repeatable key:value (brand, category, price_min, price_max, in_stock)\n- sort relevance|price_asc|price_desc|newest\n- include_facets bool default true\n\nОтвет 200:\n`json\n{\n  'total': 1234,\n  'page': 1,\n  'page_size': 24,\n  'results': [\n    { 'sku': 'SKU-123', 'title': 'Sneaker X', 'price_minor': 1299, 'currency': 'USD', 'score': 12.3 }\n  ],\n  'facets': {\n    'brand': [{'value': 'acme', 'count': 120}],\n    'category': [{'value': 'shoes', 'count': 900}]\n  }\n}\n`\n\n## GET /api/search/suggest\nQuery:\n- q required\n- limit default 8 max 20\nОтвет:\n`json\n{ 'suggestions': ['sneakers', 'sneaker cleaner'] }\n`\n\n# Таймауты\nElasticsearch client:\n- connect 50мс\n- request 150мс\nРетраи отключены, чтобы не усиливать перегруз. Если ES отвечает 429, мы возвращаем 503 SEARCH_UNAVAILABLE с retry_after_seconds=2.\n\n# Degraded mode\nПри перегрузе ES или health yellow/red:\n- SEARCH_ENABLE_AGGS=false (убираем facets)\n- SEARCH_ENABLE_SPELLCHECK=false\n- SEARCH_MAX_CONCURRENCY=40\n\nТогда:\n- facets отсутствуют\n- X-Search-Degraded=true\n\n# Алиасы\nЧитаем из products_read.\nЕсли алиас отсутствует или указывает на удаленный индекс, ES вернет index_not_found_exception, search-api отдаст 503.\n\n# Нюансы\n- q пустой: trending кешируется на 60с\n- неизвестный filter key: 400 INVALID_FILTER\n- Accept-Language неподдерживаемый: используем default analyzer\n- facets во время dual-write могут быть неидеальны, это допустимо\n\n# Rate limit\nНа edge:\n- 60 rpm на IP для /products\n- 120 rpm на IP для /suggest\nПри лимите: 429 SEARCH_RATE_LIMITED, Retry-After: 5\n\n# Observability\n- search_requests_total\n- search_latency_seconds_bucket\n- es_rejections_total\n- search_degraded_mode_enabled (gauge)\n\n# Примеры\n`bash\ncurl 'https://api.company.tld/api/search/products?q=sneakers&page=1&page_size=24&filters=brand:acme&sort=relevance'\ncurl 'https://api.company.tld/api/search/suggest?q=snea&limit=8'\n`\n\n# Связанные документы\n- ADR-2025-02\n- RB-2025-12\n- CL-2025-10",
  "language": "ru"
}