{
  "doc_key": "rb-2025-06-k8s-rollout-stuck",
  "title": "Ранбук: Rollout завис, CrashLoopBackOff, readiness не проходит",
  "doc_type": "runbook",
  "created_at": "2025-06-21",
  "content": "# Кратко\nРанбук для случаев, когда деплой в Kubernetes зависает, новые поды в CrashLoopBackOff, или readiness probe не проходит и ingress начинает отдавать 502/503.\n\nКластеры: Kubernetes 1.29, namespaces ecommerce-prod / ecommerce-staging\nСервисы: checkout-service, cart-service, search-api (FastAPI 0.110), payment-gateway (Node 18)\n\n# Типовые симптомы\n- kubectl rollout status висит > 5 минут\n- Поды: CrashLoopBackOff, ImagePullBackOff, OOMKilled, Readiness probe failed\n- Пользовательские: всплеск 5xx после деплоя, частичные ошибки (mixed versions)\n\n# Быстрый триаж\n1) Статус rollout:\n`bash\nkubectl -n ecommerce-prod rollout status deploy/checkout-service\nkubectl -n ecommerce-prod get pods -l app=checkout-service -o wide\n`\n2) Describe проблемного пода:\n`bash\nkubectl -n ecommerce-prod describe pod <pod>\n`\nСмотреть Events: pull errors, probe failures, OOM.\n\n3) Логи текущие и предыдущие:\n`bash\nkubectl -n ecommerce-prod logs <pod> --previous --tail=200\nkubectl -n ecommerce-prod logs <pod> --tail=200\n`\n\n# Митигирующие сценарии\n## A: Readiness probe падает\nПроверить локально внутри пода:\n`bash\nkubectl -n ecommerce-prod exec -it <pod> -- sh -c 'wget -qO- http://127.0.0.1:8080/health/ready || true'\n`\nЕсли readiness включает внешние зависимости, решите, должна ли она быть строгой.\nМы поддерживаем READINESS_STRICT_DEPS=false для сервисов с fallback (например cart-service может жить на Postgres без Redis).\n\nВременный фикс для cart-service:\n`bash\nkubectl -n ecommerce-prod set env deploy/cart-service READINESS_STRICT_DEPS=false\n`\nВнимание: если readiness становится слишком мягкой, вы можете начать принимать трафик в деградированном состоянии. Это нормально только как временная мера.\n\n## B: CrashLoop из-за отсутствующего env/secret\nFastAPI валидирует settings и падает быстро.\nТиповые сообщения:\n- ValidationError: Settings.STRIPE_API_KEY Field required\n- KeyError по переменной\n\nДействия:\n- проверить секрет существует\n- сравнить имена ключей в Deployment и в коде\n- если не уверены, откатить (быстрее, чем патчить на горячую)\n`bash\nkubectl -n ecommerce-prod rollout undo deploy/checkout-service\n`\n\n## C: Schema drift (миграции не применились)\nСимптом: psycopg.errors.UndefinedColumn.\nДействия:\n1) Откатить сервис.\n2) Запустить миграцию джобой против primary Postgres (не через PgBouncer):\n`bash\nkubectl -n ecommerce-prod create job --from=cronjob/checkout-migrations checkout-migrations-manual\n`\n3) После применения снова деплоить.\n\n## D: OOMKilled\nСимптом: Last State Terminated OOMKilled.\nДействия:\n- временно увеличить memory limit и посмотреть, стабилизируется ли\n- если это регрессия (логирование больших payload, кеширование в памяти), откатить и чинить в ветке\n\n## E: ImagePullBackOff\nПричины:\n- тег не собран (ошибка GitHub Actions)\n- промоут ссылается на несуществующий SHA\n- сломан imagePullSecret\n\nФикс: быстро указать прошлый известный рабочий образ или откатить rollout.\n\n# Опасность частичного rollout (mixed versions)\nДаже если readiness проходит, смешанные версии могут ломать инварианты:\n- изменение формата Redis ключей cart: vs cart2:\n- checkout-service ожидает новые error_code от cart-service\n\nЕсли подозрение на несовместимость, выбирайте rollback, а не ожидание.\n\n# Проверка после мер\n- rollout завершился\n- ingress 5xx вернулся к базовому\n- по сервису нет новых ValidationError/UndefinedColumn\n\nСмоук:\n`bash\ncurl -sSf https://api.company.tld/healthz >/dev/null\ncurl -sSf https://api.company.tld/api/search/products?q=sneakers | head -n 5\n`\n\n# После инцидента\n- Добавить pre-deploy проверки: секреты, alembic head, наличие алиаса products_read\n- Пересмотреть readiness: liveness не должен ходить во внешние системы\n- Если причина связана с миграциями, связать с PM-2025-07",
  "language": "ru"
}