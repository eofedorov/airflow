{
  "doc_key": "kb-2025-07-postmortem-migrations-caused-outage",
  "title": "Postmortem: Checkout Outage Due to Unapplied Migrations After Deploy",
  "doc_type": "postmortem",
  "created_at": "2025-07-09",
  "content": "# Incident summary\nOn 2025-07-08, checkout-service deployed version 2.14.0 which expected a new column`orders.payment_provider`. The migration job did not run due to a misconfigured GitHub Actions environment variable, causing startup crashes and a partial outage.\n\n# Impact\n- Duration: 23 minutes\n- 100% of requests to `/api/checkout/start`returned 500\n- Other services mostly unaffected\n\n# Timeline\n- 14:02 UTC: Deploy initiated\n- 14:04: Pods crashloop with`UndefinedColumn`\n- 14:06: Oncall identifies missing migration\n- 14:10: Rollback executed\n- 14:18: Migration job run manually\n- 14:25: Redeploy successful\n\n# Root cause\nThe GitHub Actions workflow `promote.yml`sets`RUN_MIGRATIONS=true`for prod. A refactor renamed the variable to`RUN_DB_MIGRATIONS`in the migration cronjob chart, but the workflow was not updated. Migration did not execute.\n\nError observed:\n-`psycopg.errors.UndefinedColumn: column orders.payment_provider does not exist`\n\n# Contributing factors\n- No pre-deploy check verifying schema head\n- Rollout allowed new pods to replace old pods quickly, removing healthy capacity\n\n# Resolution\n- Rollback checkout-service\n- Manual migration job:\n```bash\nkubectl -n ecommerce-prod create job --from=cronjob/checkout-migrations checkout-migrations-manual\n```\n- Re-deploy after verifying alembic head\n\n# Action items\n1. Add deploy checklist item: verify `alembic current`equals expected head.\n2. Enforce`maxUnavailable=0`for checkout-service to prevent total outage during crashloops.\n3. Add alert when migration job did not run during a deploy window.\n\n# Related\n- Runbook: RB-2025-06 rollout stuck\n- Checklist: CL-2025-09 prod deploy\n",
  "language": "en"
}