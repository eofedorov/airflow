{
  "doc_key": "kb-2025-09-api-checkout-service",
  "title": "API Spec: checkout-service Public API (v2)",
  "doc_type": "api_spec",
  "created_at": "2025-09-19",
  "content": "# Overview\ncheckout-service orchestrates checkout, order creation, and payment initiation via payment-gateway.\n\nBase URL:`/api/checkout`\nAuth: bearer token.\nIdempotency: required for order creation.\n\n# Endpoints\n## POST /api/checkout/start\nCreates an order draft and returns a payment intent client secret.\n\nHeaders:\n- `Idempotency-Key: <uuid>`\n\nRequest:\n```json\n{ \"user_id\": \"...\", \"cart_id\": \"...\", \"shipping_address_id\": \"...\" }\n```\n\nResponses:\n- 201:\n```json\n{ \"order_id\": \"...\", \"status\": \"PAYMENT_PENDING\", \"stripe_client_secret\": \"pi_..._secret_...\" }\n```\n- 409: `{ 'error_code': 'CART_VERSION_MISMATCH' }`\n- 422: `{ 'error_code': 'ADDRESS_INVALID' }`\n- 503: `{ 'error_code': 'PAYMENT_PROVIDER_UNAVAILABLE' }`\n\nEdge cases:\n- If cart-service returns 304 (not modified), checkout-service must still fetch cart totals from persisted snapshot to avoid mismatch.\n- If payment-gateway times out but Stripe created the intent, idempotency key must map to the same intent.\n\n## GET /api/checkout/orders/{order_id}\nReturns order status.\n\nResponses:\n- 200: order payload\n- 404: `{ 'error_code': 'ORDER_NOT_FOUND' }`\n\n## POST /api/checkout/orders/{order_id}/cancel\nCancels an unpaid order.\n\nResponses:\n- 200: cancelled\n- 409: `{ 'error_code': 'ORDER_ALREADY_PAID' }`\n\n# State machine\n- `DRAFT`->`PAYMENT_PENDING`->`PAID`->`FULFILLING`->`FULFILLED`\n- Failures:\n  - `PAYMENT_FAILED`\n  - `CANCELLED`\n\n# Error codes\n- `PAYMENT_PENDING_TIMEOUT`(order stuck > 10 minutes)\n-`PAYMENT_EVENT_DUPLICATE`(Stripe event already processed)\n\n# Observability\n-`checkout_start_total{status}`\n- `checkout_payment_pending_total`\n\n# Related docs\n- ADR-2024-12 Stripe webhooks\n- Runbook: RB-2026-01 Stripe webhook backlog\n",
  "language": "en"
}