{
  "doc_key": "pm-2025-11-redis-evictions",
  "title": "Postmortem PM-2025-11: Redis OOM/Evictions Broke Checkout Consistency",
  "doc_type": "postmortem",
  "created_at": "2025-11-30",
  "content": "# Postmortem PM-2025-11: Redis OOM/Evictions Broke Checkout Consistency\n\n## Summary\nOn 2025-11-29, Redis in `ecommerce-prod` experienced sustained memory pressure leading to heavy evictions and intermittent command latency. Because cart-service depends on Redis for high-performance cart reads (ADR-2025-03) and checkout-service relies on cart ETags for optimistic concurrency, cache churn caused a spike in `409 CART_VERSION_MISMATCH` and `412 PRECONDITION_FAILED` during checkout.\n\nThis incident did not lose cart data (Postgres remained source of truth), but it materially reduced conversion for ~47 minutes.\n\n## Impact\n- Time window: 2025-11-29 09:12–09:59 UTC (47 minutes)\n- Checkout start failures:\n  - 12.4% of `/api/checkout/start` requests returned 409/412\n  - p95 checkout latency increased from 220ms to 780ms\n- Cart page:\n  - p95 increased from 120ms to 410ms\n  - elevated “missing items” reports (mostly transient refresh issues)\n\n## Detection\nAlerts fired:\n- `RedisEvictionsHigh` (`increase(redis_evicted_keys_total[5m]) > 500`)\n- `CartVersionMismatchSpike` (checkout-service 409 rate > 5/s)\n\nOncall confirmation:\n- Grafana **Platform / Redis / Cache Health** showed `used_memory` near `maxmemory` and `evicted_keys` rising sharply.\n- cart-service dashboard showed cache miss ratio > 0.9.\n\n## Timeline (UTC)\n- 09:12: `RedisEvictionsHigh` alert triggered.\n- 09:16: checkout-service `http_409_total` spikes; support reports “cart changed” loops.\n- 09:18: Oncall checks Redis INFO; sees `used_memory` ~17.8GB / 18GB, `evicted_keys` rising.\n- 09:22: Mitigation: enable `CART_CACHE_BYPASS=true` and `CART_CACHE_WRITEBACK=false` on cart-service.\n- 09:26: Postgres read load rises but remains below 75% CPU; checkout 409 rate begins to drop.\n- 09:31: Oncall deletes a subset of oversized cart keys (last resort) to reduce Redis memory pressure.\n- 09:38: Hotfix prepared: remove embedded recommendation metadata from cart cache payload.\n- 09:45: Gradual re-enable cache reads, then writes.\n- 09:59: Metrics return to baseline; incident closed.\n\n## Root cause\nA cart-service feature launched earlier that morning included “recommended products” on the cart page. The implementation stored expanded recommendation metadata inside the cached cart payload. This increased average `cart:*` value size by ~6x (from ~30KB to ~180KB; p95 exceeded 220KB for some users).\n\nRedis maxmemory policy was `allkeys-lfu`, which protected frequently accessed keys but could not prevent eviction churn once overall memory pressure exceeded the configured 18GB. The combination of:\n- larger values,\n- a high volume of cart reads,\n- synchronized TTL expirations (insufficient jitter on some keys),\ncaused thrash: keys were evicted and immediately re-created.\n\nBecause ETag derivation in cart-service relied on the cached payload hash for some code paths, simultaneous rehydration led to transient ETag mismatches and 409 storms.\n\n## Contributing factors\n- Missing guardrails: no hard cap on cache payload size; caching should have been skipped for large payloads.\n- Load test gap: pre-release tests used small carts and did not include recommendation metadata shape.\n- Inconsistent TTL jitter: one code path for “cart with recommendations” used a fixed TTL with no jitter.\n- checkout-service did not retry on cart mismatch; it treated 409 as a hard failure.\n\n## Resolution and recovery\nShort-term:\n- Bypassed Redis cache for cart reads, reducing mismatch but increasing DB load.\n- Deleted a subset of large cart keys to reduce memory pressure.\n- Deployed hotfix to store only recommendation SKUs (not full metadata) inside cached cart payload.\n\nRecovery validation:\n- `redis_evicted_keys_total` flat for 15 minutes\n- cart-service cache miss ratio fell to < 0.5 after re-enable\n- checkout-service 409 rate returned to baseline\n\n## What went well\n- Feature flag `CART_CACHE_BYPASS` existed and was documented.\n- PgBouncer prevented Postgres connection exhaustion when read load spiked.\n- Oncall had direct access to dashboards and could correlate symptoms quickly.\n\n## What went poorly\n- A performance optimization became a correctness-adjacent failure mode (checkout mismatch).\n- Manual key deletion increased DB load and briefly increased latency (trade-off accepted).\n- We did not have visibility into per-key-prefix value sizes until after the incident.\n\n## Action items\n1. Implement `CART_CACHE_MAX_BYTES=131072` (128KB) and skip caching beyond cap.\n2. Add metric: `cart_cache_value_size_bytes` (p50/p95) and alert on spikes.\n3. Ensure TTL jitter is applied uniformly; add unit tests around TTL setting logic.\n4. Update checkout-service to retry once on `CART_VERSION_MISMATCH` by refetching cart and refreshing ETag.\n5. Update ADR-2025-03 with an explicit “do not cache expanded metadata” guideline.\n\n## Related docs\n- ADR-2025-03 Redis as primary cache for carts\n- RB-2026-02 Redis evictions causing cart staleness",
  "language": "en"
}