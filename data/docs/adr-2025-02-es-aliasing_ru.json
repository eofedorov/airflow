{
  "doc_key": "adr-2025-02-es-aliasing",
  "title": "ADR-2025-02: Алиасы Elasticsearch и reindex без простоя",
  "doc_type": "adr",
  "created_at": "2025-02-06",
  "content": "# Статус\nПринято (2025-02-06)\n\n# Контекст\nМаппинги Elasticsearch часто нужно менять (анализаторы, новые поля, типы). In-place изменения ограничены. Полный reindex каталога занимает часы. Раньше у нас был один индекс products-current, что делало деплои рискованными и плохо откатываемыми.\n\nНужно:\n- атомарный cutover\n- быстрый rollback\n- независимые релизы search-api и indexing-worker\n\n# Решение\nВводим read/write алиасы:\n- products_read\n- products_write\n\nКонкретные индексы: products-v3-YYYY.MM.DD\nindexing-worker пишет в products_write, search-api читает products_read. Во время миграций алиасы могут указывать на разные индексы.\n\n# Дизайн\n## Шаблон и ограничения\nTemplate: products-template-v3\nПравила:\n- attributes.* нормализовать, избегать field explosion\n- index.mapping.total_fields.limit=1000\n\nПример settings:\n`json\n{\n  \"number_of_shards\": 12,\n  \"number_of_replicas\": 1,\n  \"index.mapping.total_fields.limit\": 1000\n}\n`\n\n## Процесс cutover\n1) Создать новый индекс products-v3-<today>.\n2) Backfill:\n- предпочтительно из Postgres снапшота\n- запасной вариант: _reindex со старого\n3) Включить dual-write:\n- INDEX_DUAL_WRITE=true\n- INDEX_DUAL_WRITE_TARGET=products-v3-<today>\n4) Переключить products_read на новый индекс.\n5) Проверить query parity и doc counts.\n6) Переключить products_write и выключить dual-write.\n\n## Валидация\n- doc count в пределах 0.5 процента\n- 20 каноничных запросов дают близкие totals (+/- 5%)\n- нет query_shard_exception в логах\n\n## Rollback\nRollback = вернуть products_read на старый индекс. Это ключевой плюс.\n\n# Последствия\nПлюсы:\n- reindex без простоя\n- быстрый rollback\n\nМинусы:\n- доп storage во время dual-write\n- operational complexity: алиасы, ILM и ретеншн должны быть корректны\n- новый failure mode: products_read отсутствует или указывает на удаленный индекс => search-api падает index_not_found_exception (см. RB-2025-12)\n\n# Edge cases\n- Disk watermark: unassigned shards, алиасы не помогут\n- Type conflicts: смена типа поля приводит к mapper_parsing_exception\n- Analyzer changes: релевантность меняется, нужен sign-off продукта\n\n# Follow-ups\n- ILM должен покрывать products-v3-*.\n- Еженедельный чеклист проверяет алиасы и ретеншн.\n\n# Примечание\nВ 2025-12 был инцидент с red кластером из-за дисков. В контексте этой ADR важно: алиасы решают проблему миграций, но не решают проблему capacity и ретеншна.",
  "language": "ru"
}