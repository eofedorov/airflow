{
  "doc_key": "rb-2025-06-k8s-rollout-stuck",
  "title": "Runbook: Kubernetes Rollout Stuck / CrashLoopBackOff",
  "doc_type": "runbook",
  "created_at": "2025-06-21",
  "content": "# Summary\nThis runbook covers Kubernetes rollouts that get stuck, pods that CrashLoopBackOff, and deployments that silently degrade during release. It is written for our core services: checkout-service, cart-service, search-api (FastAPI) and payment-gateway (Node).\n\nCommon user-visible symptoms include sudden 5xx spikes right after deploys, readiness failures causing zero capacity, and partial rollouts where mixed versions produce inconsistent behavior.\n\n# Scope and prerequisites\nNamespace: `ecommerce-prod` (prod), `ecommerce-staging` (staging)  \nCluster: Kubernetes 1.29  \nIngress: nginx-ingress  \nStandard container ports:\n- FastAPI: 8080\n- Node payment-gateway: 8090\n\nHealth endpoints (expected):\n- `/health/live` (local-only checks)\n- `/health/ready` (may include dependency checks; see notes below)\n\n# Symptoms\n- `kubectl rollout status` hangs > 5 minutes\n- Pods show:\n  - `CrashLoopBackOff`\n  - `ImagePullBackOff`\n  - `OOMKilled`\n  - `Readiness probe failed`\n- User-facing:\n  - Increased 502/503 from ingress\n  - checkout-service `/api/checkout/start` returns 500 with validation errors\n\n# Quick triage\n## 1) Identify whether the rollout is blocked by readiness\n```bash\nkubectl -n ecommerce-prod rollout status deploy/checkout-service\nkubectl -n ecommerce-prod get rs -l app=checkout-service\nkubectl -n ecommerce-prod get pods -l app=checkout-service -o wide\n```\nIf new ReplicaSet has pods but they never become ready: it’s usually readiness probe or startup crash.\n\n## 2) Describe one failing pod\n```bash\nkubectl -n ecommerce-prod describe pod <pod>\n```\nLook at:\n- Events (image pull errors, probe failures)\n- Last termination reason (OOMKilled)\n- Environment (missing config)\n\n## 3) Check logs (current and previous)\n```bash\nkubectl -n ecommerce-prod logs <pod> --previous --tail=200\nkubectl -n ecommerce-prod logs <pod> --tail=200\n```\nCommon patterns:\n- Pydantic settings validation:\n  - `ValidationError: Settings.STRIPE_API_KEY Field required`\n- DB mismatch:\n  - `psycopg.errors.UndefinedColumn: column ... does not exist`\n- Redis DNS:\n  - `Name or service not known: redis.ecommerce-prod.svc`\n- Node webhook failures:\n  - `StripeSignatureVerificationError` (see Stripe runbook)\n\n# Mitigation paths\n## A) Readiness probe failures\n### Confirm readiness endpoint works locally\n```bash\nkubectl -n ecommerce-prod exec -it <pod> -- sh\nwget -qO- http://127.0.0.1:8080/health/ready\n```\nIf it fails:\n- If it fails due to dependency checks (Redis/ES), decide whether readiness should be strict.\n- We support `READINESS_STRICT_DEPS=false` for services where we prefer serving partial functionality.\n\n**Rule of thumb:** liveness must never call external systems. Readiness may, but be careful: strict readiness can cause total outage if Redis is flaky.\n\n### Temporary mitigation\n- For cart-service: set `READINESS_STRICT_DEPS=false` if Redis is down and you prefer DB fallback.\n```bash\nkubectl -n ecommerce-prod set env deploy/cart-service READINESS_STRICT_DEPS=false\n```\n\n## B) CrashLoopBackOff due to missing env var / secret\n1. Confirm the secret exists:\n```bash\nkubectl -n ecommerce-prod get secret checkout-service-secrets -o yaml | head\n```\n2. Compare the env var names in the Deployment vs the service settings docs.\n3. If a secret key was renamed, fastest safe option is rollback.\n\nRollback:\n```bash\nkubectl -n ecommerce-prod rollout undo deploy/checkout-service\n```\n\n## C) Schema migration mismatch\nIf logs show `UndefinedColumn` or `Can't locate revision`:\n1. Roll back immediately to restore capacity (unless you know migration is already running).\n2. Run migration job manually against primary Postgres:\n```bash\nkubectl -n ecommerce-prod create job --from=cronjob/checkout-migrations checkout-migrations-manual\n```\n3. Verify `alembic head` is applied before redeploy.\n\n**Important:** migrations must not go through PgBouncer (transaction pooling can break some migration patterns).\n\n## D) OOMKilled\n1. Confirm via describe: `Last State: Terminated (OOMKilled)`.\n2. Check Grafana: **K8s / Pod Memory** for the new version.\n3. Mitigation options:\n- Raise memory limit temporarily (e.g., 800Mi -> 1200Mi) and redeploy.\n- Roll back if memory growth is due to a regression (common: logging payloads, loading huge config, caching too much in-process).\n\n## E) ImagePullBackOff\n1. Confirm image tag exists in registry and the cluster has pull access.\n2. Common causes:\n- GitHub Actions pushed to the wrong repository\n- Promotion workflow referenced a tag that was never built\n- imagePullSecret missing in namespace\n\nFastest fix: repoint to last known good image, then fix CI.\n\n# Partial rollout hazards (mixed versions)\nEven when readiness works, partial rollouts can break invariants:\n- cart-service new key format `cart2:` vs old `cart:` leads to cache misses and higher DB load.\n- checkout-service expecting new error codes from cart-service results in 500 on unrecognized responses.\n\nIf you suspect mixed-version incompatibility:\n- Prefer rollback rather than “wait it out”.\n- If you must proceed, temporarily pin traffic (or scale down old ReplicaSet) only after verifying the new version is fully healthy.\n\n# Verification\nAfter mitigation:\n- Rollout completes.\n- Ingress 5xx returns to baseline.\n- Service error budgets stop burning.\n\nSmoke test commands:\n```bash\ncurl -sSf https://api.company.tld/healthz\ncurl -sSf https://api.company.tld/api/search/products?q=sneakers | head\n```\n\n# Post-incident follow-ups\n- Add a pre-deploy gate: verify required secrets and alembic head.\n- Ensure readiness endpoints are consistent and documented.\n- Link incident to PM-2025-07 migrations outage if relevant.",
  "language": "en"
}