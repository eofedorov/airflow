{
  "doc_key": "ob-2025-05-fastapi-local",
  "title": "Onboarding: Working on FastAPI Services Locally",
  "doc_type": "onboarding",
  "created_at": "2025-05-05",
  "content": "# Onboarding: Working on FastAPI Services Locally (checkout-service, cart-service, search-api)\n\n## Scope\nThis guide gets you from “fresh laptop” to running our core FastAPI services with realistic dependencies. It’s opinionated and includes the things that actually trip people up (ports, env vars, migrations, seed data).\n\nServices covered:\n- checkout-service (FastAPI 0.110, Python 3.11, SQLAlchemy 2.0, psycopg)\n- cart-service (FastAPI 0.110, Python 3.11, Redis cache)\n- search-api (FastAPI 0.110, Python 3.11, Elasticsearch client 8.x)\n\nLegacy service (not covered in depth here):\n- payment-gateway (Node 18) – see Payments onboarding.\n\n## Prerequisites\n- Docker Desktop 4.27+ (or Linux Docker Engine)\n- Python 3.11.7\n- Poetry 1.8+\n- Make (optional, but our scripts assume it exists)\n- For k8s dev: kubectl 1.29+, kind 0.22+\n\n## Repo layout\n- `checkout-service/`\n- `cart-service/`\n- `search-api/`\n- `infra/` (docker-compose, local k8s manifests)\n- `docs/` (conventions, runbooks, ADRs)\n\n## Start dependencies via docker-compose\nFrom `infra/`:\n```bash\ndocker compose up -d postgres redis elasticsearch\ndocker compose ps\n```\nDefault endpoints:\n- Postgres: `localhost:5432` db `ecommerce`, user `app`, password `app`\n- Redis: `localhost:6379` db 0\n- Elasticsearch: `http://localhost:9200` (single-node, no auth)\n\nIf docker-compose fails due to port conflicts, the fastest fix is to edit `infra/docker-compose.yml` ports and update your env vars accordingly.\n\n## Database bootstrap\nWe use Alembic migrations. There is no “shared migrations repo”; each service owns its own schema changes. For local dev you typically run checkout-service migrations first because it creates core order/payment tables.\n\n```bash\ncd checkout-service\npoetry install\nexport DATABASE_URL=postgresql+psycopg://app:app@localhost:5432/ecommerce\npoetry run alembic upgrade head\n```\n\nCommon migration errors:\n- `Can't locate revision identified by '...'` → your repo is out of date or your local DB has a weird migration history. If in doubt, drop and recreate local DB.\n- `psycopg.errors.InsufficientPrivilege` → you’re not using the `app` user from compose.\n\n## Running checkout-service\n```bash\ncd checkout-service\nexport DATABASE_URL=postgresql+psycopg://app:app@localhost:5432/ecommerce\nexport REDIS_URL=redis://localhost:6379/0\nexport PAYMENT_GATEWAY_URL=http://localhost:8090\nexport SERVICE_ENV=local\npoetry run uvicorn app.main:app --reload --port 8081\n```\n\nHealth endpoints:\n- `GET /health/live` (no dependency checks)\n- `GET /health/ready` (depends on DB; Redis optional)\n\nIf startup fails with:\n- `ValidationError: Settings.STRIPE_API_KEY Field required`\nSet a dummy value locally:\n```bash\nexport STRIPE_API_KEY=sk_test_dummy\n```\nWe do not hit Stripe directly from checkout-service, but the settings model is shared.\n\n## Running cart-service\n```bash\ncd cart-service\npoetry install\nexport DATABASE_URL=postgresql+psycopg://app:app@localhost:5432/ecommerce\nexport REDIS_URL=redis://localhost:6379/0\nexport CART_CACHE_TTL_SECONDS=900\nexport READINESS_STRICT_DEPS=false\npoetry run uvicorn app.main:app --reload --port 8082\n```\nNote: `READINESS_STRICT_DEPS=false` is recommended locally because Redis restarts are common and you still want the service to run using Postgres fallback.\n\n## Running search-api\n```bash\ncd search-api\npoetry install\nexport ELASTICSEARCH_URL=http://localhost:9200\nexport SERVICE_ENV=local\npoetry run uvicorn app.main:app --reload --port 8083\n```\nInitialize local index:\n```bash\npython scripts/create_index.py --index products-v3-local\npython scripts/seed_products.py --count 500\n```\nIf you see:\n- `index_not_found_exception: no such index [products_read]`\nThat’s because production uses aliases. Locally, either create the alias or configure `SEARCH_INDEX_NAME=products-v3-local`.\n\n## Tests\n- Unit tests:\n```bash\npoetry run pytest -q\n```\n- Integration tests require docker-compose deps:\n```bash\npytest -q -m integration\n```\nIf tests hang, it’s usually waiting for Postgres. Check `DATABASE_URL` and that compose is running.\n\n## Debugging conventions\n- We propagate `X-Request-Id` across services. You can set it manually in curl.\n- Standard error body:\n```json\n{ \"error_code\": \"...\", \"message\": \"...\", \"request_id\": \"...\" }\n```\n- For cart cache debugging (staging only), you can enable:\n  - `LOG_CACHE_KEYS=true` to see key formats (do not do in prod).\n\n## “Gotchas” that waste time\n- Poetry env mismatch: if `poetry install` pulls Python 3.12, you’ll hit dependency pins. Force Python 3.11.\n- Elasticsearch mapping drift: if you change templates, delete and recreate local index.\n- Mixed ports: we use 8081/8082/8083 locally; prod uses 8080 inside containers. Don’t copy-paste Kubernetes probes into local scripts without adjusting.\n\n## Next documents to read\n- API specs: cart-service v1, checkout-service v2, search-api v3\n- Runbooks: Redis evictions, Stripe webhook backlog, K8s rollout stuck",
  "language": "en"
}