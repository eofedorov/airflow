{
  "doc_key": "kb-2025-03-adr-redis-cart-cache",
  "title": "ADR-2025-03: Redis as Primary Cache for Carts (LFU eviction policy)",
  "doc_type": "adr",
  "created_at": "2025-03-11",
  "content": "# Status\nAccepted\n\n# Context\nCart reads are among our highest QPS endpoints. Postgres load during peak sales events led to elevated p95 (> 450ms) on cart-service. We need a low-latency cache, and we already operate Redis.\n\nWe previously cached carts in-process, but:\n- Pods scale horizontally, cache warmup is inconsistent\n- Deploys flush in-process caches\n- Memory usage was unpredictable\n\n# Decision\nUse Redis as the primary cache for cart payloads in **cart-service**, with Postgres as the source of truth.\n- Cache key format:`cart:{user_id}:v`\n- Cache TTL: 900 seconds\n- Eviction policy: `allkeys-lfu`\n- Payload: msgpack-encoded cart model (v2)\n\n# Technical details\n## Redis config\nBaseline config snippet:\n```conf\nmaxmemory 18gb\nmaxmemory-policy allkeys-lfu\nactivedefrag yes\ntimeout 0\n```\n\n## cart-service behavior\n1. Read-through cache:\n- GET `/api/cart/{user_id}`:\n  - Try Redis, if hit return cached cart.\n  - If miss, load from Postgres, write to Redis.\n2. Write-through on mutation:\n- POST `/api/cart/{user_id}/items`:\n  - Update Postgres transactionally.\n  - Publish event `cart.updated`.\n  - Update Redis key.\n\n## ETag / concurrency\ncheckout-service uses ETag for optimistic concurrency.\n- `ETag`derived from`cart.version`and item hashes.\n- Response header:`ETag: W/{etag}`\n\n## Failure mode\nIf Redis is unavailable:\n- Fall back to Postgres.\n- Set header `X-Cache: bypass`.\n\n# Consequences\n## Positive\n- Reduced Postgres load during peaks\n- Faster cart page loads\n\n## Negative / risks\n- Redis eviction under memory pressure can cause cache churn.\n- If ETag derivation depends on cached payload and keys are evicted, version mismatch behavior can worsen.\n\n# Alternatives\n## A) Store carts fully in Redis (source of truth)\nRejected: higher risk of data loss and complex durability.\n\n## B) Use Postgres only with aggressive indexing\nRejected: cost and limited latency improvement.\n\n# Follow-ups\n- Add alerting on Redis evictions.\n- Document incident response (see RB-2026-02 Redis evictions).\n\n# Note\nThis ADR prioritizes performance. If we observe eviction-driven incidents, we may need to revisit TTL, key size limits, or move to a smaller cached representation.\n",
  "language": "en"
}