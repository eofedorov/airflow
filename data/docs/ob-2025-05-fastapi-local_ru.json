{
  "doc_key": "ob-2025-05-fastapi-local",
  "title": "Онбординг: локальная разработка FastAPI сервисов",
  "doc_type": "onboarding",
  "created_at": "2025-05-05",
  "content": "# Цель\nПоднять локально checkout-service, cart-service, search-api с зависимостями (Postgres, Redis, Elasticsearch) и уметь прогонять тесты. Документ специально содержит неприятные детали: порты, переменные окружения, миграции, сиды.\n\n# Что у нас есть\n- checkout-service: FastAPI 0.110, Python 3.11, SQLAlchemy 2.0, psycopg\n- cart-service: FastAPI 0.110, Redis кеш\n- search-api: FastAPI 0.110, ES client 8.x\n- payment-gateway (Node 18) в этом гайде почти не трогаем\n\n# Пререквизиты\n- Docker Desktop 4.27+\n- Python 3.11.7\n- Poetry 1.8+\n\n# Запуск зависимостей\nИз папки infra:\n`bash\ndocker compose up -d postgres redis elasticsearch\ndocker compose ps\n`\nЭндпойнты:\n- Postgres localhost:5432 db ecommerce user app pass app\n- Redis localhost:6379 db 0\n- Elasticsearch http://localhost:9200 (без auth)\n\nЕсли конфликт портов, проще всего поменять ports в docker-compose и поправить env.\n\n# База и миграции\nКаждый сервис владеет своими миграциями. Обычно сначала гоняют checkout-service, потому что он создает таблицы orders/payments.\n\n`bash\ncd checkout-service\npoetry install\nexport DATABASE_URL=postgresql+psycopg://app:app@localhost:5432/ecommerce\npoetry run alembic upgrade head\n`\n\nТиповые проблемы:\n- Cant locate revision: репо не обновлено или DB сломана. Проще пересоздать локальную БД.\n- InsufficientPrivilege: используете не того юзера.\n\n# Запуск checkout-service\n`bash\ncd checkout-service\nexport DATABASE_URL=postgresql+psycopg://app:app@localhost:5432/ecommerce\nexport REDIS_URL=redis://localhost:6379/0\nexport PAYMENT_GATEWAY_URL=http://localhost:8090\nexport SERVICE_ENV=local\nexport STRIPE_API_KEY=sk_test_dummy\npoetry run uvicorn app.main:app --reload --port 8081\n`\nHealth:\n- GET /health/live\n- GET /health/ready\n\nВажно: STRIPE_API_KEY нужен только чтобы пройти валидацию settings, checkout-service не должен напрямую дергать Stripe.\n\n# Запуск cart-service\n`bash\ncd cart-service\npoetry install\nexport DATABASE_URL=postgresql+psycopg://app:app@localhost:5432/ecommerce\nexport REDIS_URL=redis://localhost:6379/0\nexport CART_CACHE_TTL_SECONDS=900\nexport READINESS_STRICT_DEPS=false\npoetry run uvicorn app.main:app --reload --port 8082\n`\nREADINESS_STRICT_DEPS=false локально рекомендован, потому что Redis часто рестартится.\n\n# Запуск search-api\n`bash\ncd search-api\npoetry install\nexport ELASTICSEARCH_URL=http://localhost:9200\nexport SERVICE_ENV=local\nexport SEARCH_INDEX_NAME=products-v3-local\npoetry run uvicorn app.main:app --reload --port 8083\n`\n\nИнициализация локального индекса:\n`bash\npython scripts/create_index.py --index products-v3-local\npython scripts/seed_products.py --count 500\n`\nЕсли видите index_not_found_exception по products_read, это потому что в проде используется алиас. Локально используйте SEARCH_INDEX_NAME или создайте алиас вручную.\n\n# Тесты\n`bash\npoetry run pytest -q\npytest -q -m integration\n`\nИнтеграционные тесты ждут Postgres/Redis/ES. Если зависают, проверьте что docker compose поднят.\n\n# Конвенции дебага\n- X-Request-Id прокидываем между сервисами\n- Ошибки в формате:\n  - error_code\n  - message\n  - request_id\n\n# Частые грабли\n- Poetry подхватил Python 3.12 и сломал pin зависимостей\n- ES mapping drift: проще снести локальный индекс и пересоздать\n- Порты: локально 8081/8082/8083, в контейнере 8080\n\n# Что читать дальше\n- API: cart-service v1, checkout-service v2, search-api v3\n- Ранбуки: Redis eviction, Stripe webhook backlog, ES red\n- Чеклист прод-деплоя",
  "language": "ru"
}