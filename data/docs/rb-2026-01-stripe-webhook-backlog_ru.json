{
  "doc_key": "rb-2026-01-stripe-webhook-backlog",
  "title": "Ранбук: backlog Stripe webhook и заказы в PAYMENT_PENDING",
  "doc_type": "runbook",
  "created_at": "2026-01-14",
  "content": "# Кратко\nРанбук для случаев, когда Stripe webhooks начинают обрабатываться с задержкой, и заказы висят в PAYMENT_PENDING, возвраты не завершаются, или растет очередь stripe_webhook_queue_depth.\n\nГлавное: не пытайтесь чинить это срочным поллингом Stripe в горячем пути. Мы договорились, что вебхуки являются источником истины (ADR-2024-12). Поллинг допускается только как ре-консиляция.\n\nСервисы: payment-gateway (Node 18), checkout-service (FastAPI)\n\n# Симптомы\n## Пользовательские\n- Платеж подтвержден банком, но в нашем UI долго pending (больше 2 минут)\n- В Stripe Dashboard PaymentIntent succeeded, а у нас payment_status=PENDING\n- Refund requested висит без завершения\n\n## Метрики/алерты\n- stripe_webhook_queue_depth > 2000 10 минут\n- рост stripe_signature_fail_total\n- рост 5xx на POST /webhooks/stripe\n\n# Текущая схема\n1) Stripe шлет POST /webhooks/stripe на payment-gateway.\n2) payment-gateway проверяет подпись. Stripe API version закреплен 2023-10-16.\n3) Сырые события пишутся в Postgres таблицу stripe_events (PK event_id).\n4) Воркер обрабатывает события и обновляет payments/orders.\n5) checkout-service читает состояние из Postgres, не ходит в Stripe.\n\nИдемпотентность:\n- Уникальный stripe_events.event_id\n- Redis ключ stripe:evt:<event_id> TTL 7 дней (ускорение, не корректность)\n\n# Быстрый триаж\n1) В Stripe Dashboard посмотреть Delivery для endpoint webhooks/stripe.\nТиповые коды:\n- 400 invalid_signature\n- 413 payload too large\n- 429 throttling\n- 500 мы падаем до persistence\n\n2) Логи payment-gateway:\n`bash\nkubectl -n ecommerce-prod logs deploy/payment-gateway --since=15m | egrep 'invalid_signature|Signature|payload too large|OOMKilled|ETIMEDOUT|deadlock'\n`\n\n3) Проверить, что raw body не ломается.\nWebhook маршрут обязан быть на express.raw:\n`js\napp.post('/webhooks/stripe', express.raw({ type: 'application/json' }), handleStripeWebhook)\n`\nЕсли кто-то включил глобально express.json до этого маршрута, подписи начнут валиться.\n\n4) Проверить, что события вообще пишутся:\n`sql\nselect max(created_at) from stripe_events;\nselect count(*) from stripe_events where created_at > now() - interval '10 minutes';\n`\n\n# Митигирующие действия\n## A: invalid_signature (400)\nЦель: перестать отбрасывать валидные события.\n- Проверить STRIPE_WEBHOOK_SECRET актуален\n- Проверить ingress не модифицирует тело запроса\n- Если подозрение на регрессию парсинга, быстрый вариант: rollback payment-gateway на прошлый тег (например 1.38.2)\n`bash\nkubectl -n ecommerce-prod rollout undo deploy/payment-gateway\n`\n\n## B: 413 payload too large\nЧасто возникает при expand объектов (invoice lines) или неожиданно больших event payload.\n- Увеличить лимит тела на ingress для этого пути:\n`yaml\nnginx.ingress.kubernetes.io/proxy-body-size: 2m\n`\n- Проверить, что маршрут не проходит через промежуточный gateway с лимитом 1МБ.\n\n## C: Очередь растет, но ответы Stripe 2xx\nЗначит ingest ok, тормозит процессинг.\n- Увеличить WEBHOOK_MAX_CONCURRENCY умеренно (20 -> 50)\n- Отключить побочные эффекты на время: PAYMENTS_SEND_EMAILS=false\n- Перевести в режим persist+defer: WEBHOOK_DEFER_PROCESSING=true\n- Если очередь в Redis и Redis деградирует, временно: WEBHOOK_QUEUE_BACKEND=memory (не durable)\n\n## D: Postgres таймауты\nЕсли payment-gateway возвращает 500 из-за БД, Stripe будет ретраить, backlog на стороне Stripe тоже растет.\n- Уменьшить concurrency (WEBHOOK_MAX_CONCURRENCY=10)\n- Проверить connection exhaustion (см. RB-2024-11)\n- Если deadlock detected, смотреть последние миграции и индексы на stripe_events/payments\n\n# Безопасный replay\nОбычно Stripe ретраи достаточно. Ручной replay нужен только если мы когда-то вернули 2xx без записи в БД (это баг).\nЗапуск джобы:\n`bash\nkubectl -n ecommerce-prod create job --from=cronjob/stripe-webhook-replay stripe-webhook-replay-manual\n`\nПравила:\n- idempotent по event_id\n- терпит out-of-order типы\n\n# Проверка восстановления\n- В Stripe Dashboard последние доставки 2xx\n- stripe_webhook_queue_depth падает\n- В payments за последние 30 минут доля PENDING не растет\n\nSQL:\n`sql\nselect payment_status, count(*) from payments where created_at > now() - interval '30 minutes' group by 1;\nselect type, count(*) from stripe_events where created_at > now() - interval '30 minutes' group by 1 order by 2 desc;\n`\n\n# Edge cases\n- Out-of-order: refund события могут прийти до succeeded при ретраях\n- Дубликаты: Stripe может прислать один event_id несколько раз. Нельзя убирать уникальность, это сломает корректность.\n- Partial rollout секрета: часть подов принимает, часть отклоняет, будет каша из 2xx и 400.\n- Дрейф часов: подпись может падать по tolerance. Если только один узел ломается, проверьте NTP.\n\n# Ссылки\n- ADR-2024-12 вебхуки как источник истины\n- OB-2025-04 онбординг по платежам\n- PM-2025-08 дубликаты отгрузки при ретраях",
  "language": "ru"
}